<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <title>SpotSwap â€” Scambia spot</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
   integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
   crossorigin=""/>
  <style>
    :root{
      --bg:#0d0d0d;
      --bg-light:#1a1a1a;
      --card:#1f1f1f;
      --card-hover:#252525;
      --border:#2a2a2a;
      --border-light:#333;
      --text:#f5f5f5;
      --text-muted:#999;
      --primary:#dc2626;
      --primary-hover:#b91c1c;
      --primary-light:#ef4444;
      --success:#22c55e;
      --warning:#f59e0b;
      --danger:#dc2626;
      --info:#6366f1;
      --radius:10px;
      --shadow:0 2px 8px rgba(0,0,0,.3);
      --shadow-lg:0 8px 24px rgba(0,0,0,.4)
    }
    
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;overflow-x:hidden;width:100%}
    body{
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
      color:var(--text);
      background:var(--bg);
      line-height:1.5;
      -webkit-font-smoothing:antialiased;
      position:relative;
      max-width:100vw;
      overflow-x:hidden;
      touch-action: pan-x pan-y;
    }

    /* LOADING OVERLAY */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      padding: 20px;
      width: 100vw;
      height: 100vh;
      height: 100dvh; /* Fix per mobile */
      margin: 0;
      overflow: hidden;
      touch-action: none;
    }
    
    /* Fix specifico per iOS */
    @supports (-webkit-touch-callout: none) {
      .loading-overlay {
        min-height: -webkit-fill-available;
        height: -webkit-fill-available;
      }
    }
    
    .loading-overlay.show {
      display: flex;
    }
    
    .loading-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      max-width: 90%;
      position: relative;
      z-index: 10000;
      padding: 20px;
    }
    
    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(255, 255, 255, 0.1);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    .loading-text {
      margin-top: 20px;
      color: var(--text);
      font-size: 16px;
      font-weight: 600;
      text-align: center;
      width: 100%;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Fix per iOS Safari */
    @supports (-webkit-touch-callout: none) {
      .loading-overlay {
        height: -webkit-fill-available;
      }
    }
    /* PREVENZIONE ZOOM SU MOBILE */
    html {
      touch-action: manipulation;
      -webkit-text-size-adjust: 100%;
      -ms-text-size-adjust: 100%;
      text-size-adjust: 100%;
    }
    
    body {
      touch-action: pan-x pan-y;
      -webkit-user-drag: none;
      -webkit-tap-highlight-color: transparent;
    }
    
    input, textarea, select {
      font-size: 16px !important; /* Previene lo zoom automatico su iOS */
    }
    
    /* Disabilita double-tap per zoom */
    * {
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }
    
    /* Permetti selezione sui campi input */
    input, textarea {
      -webkit-user-select: text;
      user-select: text;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    


    /* LAYOUT */
    header{
      background:linear-gradient(135deg,#1a1a1a 0%,#0d0d0d 100%);
      border-bottom:1px solid var(--border);
      position:sticky;
      top:0;
      z-index:100;
      backdrop-filter:blur(10px);
      width:100%;
      display:none
    }
    
    .header-content{
      max-width:1200px;
      margin:0 auto;
      padding:12px 20px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      width:100%
    }
    
    .logo-area{
      display:flex;
      align-items:center;
      gap:10px;
      flex-shrink:0
    }
    
    .logo{
      width:40px;
      height:40px;
      border-radius:50%;
      display:grid;
      place-items:center;
      overflow:hidden;
      box-shadow:0 4px 12px rgba(220,38,38,.3)
    }
    
    .logo img{
      width:100%;
      height:100%;
      object-fit:cover
    }
    
    .brand h1{
      font-size:18px;
      color:var(--text);
      white-space:nowrap;
      font-weight:700;
      letter-spacing:-.5px;
      line-height:1.2
    }
    
    .brand p{
      font-size:11px;
      color:var(--text-muted);
      white-space:nowrap;
      font-weight:500
    }
    
    .brand .gang-name{
      font-size:10px;
      color:var(--primary);
      margin-top:2px;
      font-weight:600
    }

    nav{
      display:flex;
      gap:6px;
      flex-wrap:nowrap;
      justify-content:flex-end;
      flex:1;
      min-width:0;
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      scrollbar-width:none
    }
    
    nav::-webkit-scrollbar{
      display:none
    }
    
    .nav-btn{
      background:transparent;
      border:1px solid var(--border);
      color:var(--text);
      padding:8px 14px;
      border-radius:7px;
      cursor:pointer;
      font-weight:600;
      transition:all .2s cubic-bezier(0.4,0,0.2,1);
      font-size:13px;
      position:relative;
      white-space:nowrap;
      flex-shrink:0;
      z-index: 2; /* Aggiungi questa riga */
      margin-top: -1px; /* Aggiungi questa riga */
    }
    /* Fix per il layout della navigazione su mobile */
@media (max-width: 768px) {
  nav {
    width: 100%;
    display: flex;
    gap: 4px;
    padding: 4px 0;
    margin-top: 8px;
    position: relative;
    z-index: 5;
  }
  
  .nav-btn {
    flex: 1;
    min-width: 0;
    padding: 8px 6px;
    font-size: 12px;
    border: 1px solid var(--border);
    position: relative;
    z-index: 2;
    background: var(--card);
    margin: 0 1px;
    transform: translateZ(0); /* Fix per hardware acceleration */
  }
  
  .nav-btn.active {
    background: linear-gradient(135deg, var(--primary), var(--primary-light));
    border-color: var(--primary);
    color: #fff;
    box-shadow: 0 2px 8px rgba(220,38,38,.3);
    position: relative;
    z-index: 3;
    transform: translateY(0) !important;
  }
  
  /* Rimuovi l'hover su mobile */
  .nav-btn:hover {
    transform: none !important;
  }
  
  /* Contenitore principale della navigazione */
  .header-content {
    gap: 8px !important;
    padding: 8px 12px !important;
  }
}
    .nav-btn:hover{
      background:var(--card);
      border-color:var(--primary);
      transform:translateY(-1px)
    }
    
    .nav-btn.active{
      background:linear-gradient(135deg,var(--primary),var(--primary-light));
      border-color:var(--primary);
      color:#fff;
      box-shadow:0 4px 12px rgba(220,38,38,.25);
      z-index: 3; /* Aggiungi questa riga */
    }

    .nav-btn .badge-count{
      position:absolute;
      top:-6px;
      right:-6px;
      background:var(--primary);
      color:#fff;
      border-radius:10px;
      padding:2px 6px;
      font-size:10px;
      font-weight:700;
      min-width:16px;
      text-align:center;
      box-shadow:0 2px 6px rgba(220,38,38,.4)
    }

    .container{
      max-width:1200px;
      margin:0 auto;
      padding:20px;
      width:100%;
      overflow-x:hidden;
      display:none
    }

    /* CARDS */
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:20px;
      margin-bottom:16px;
      transition:all .3s ease;
      width:100%
    }

    .spot-card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:16px;
      cursor:pointer;
      transition:border-color .2s ease, box-shadow .2s ease;
      position:relative;
      overflow:hidden;
      width:100%;
      will-change:transform
    }
    
    .spot-card::before{
      content:'';
      position:absolute;
      top:0;
      left:0;
      right:0;
      height:2px;
      background:linear-gradient(90deg,var(--primary),var(--primary-light));
      opacity:0;
      transition:opacity .3s ease
    }
    
    @media (min-width:769px){
      .spot-card:hover{
        border-color:var(--primary);
        transform:translateY(-4px);
        box-shadow:var(--shadow-lg);
        background:var(--card-hover)
      }
      
      .spot-card:hover::before{
        opacity:1
      }
    }

    .spot-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      margin-bottom:10px
    }

    .spot-title{
      font-size:15px;
      font-weight:700;
      margin-bottom:4px;
      color:var(--text);
      letter-spacing:-.3px
    }

    .spot-meta{
      font-size:12px;
      color:var(--text-muted);
      display:flex;
      align-items:center;
      gap:4px;
      font-weight:500
    }

    .spot-exchange{
      background:var(--bg-light);
      border:1px solid var(--border);
      border-radius:7px;
      padding:10px;
      margin:10px 0;
      font-size:13px;
      width:100%
    }

    .spot-exchange-row{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      margin-bottom:4px
    }
    
    .spot-exchange-row:last-child{
      margin-bottom:0
    }

    .spot-exchange strong{
      color:var(--primary);
      font-weight:700;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.5px
    }

    .tags{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:10px
    }

    /* BADGES */
    .badge{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:4px 8px;
      border-radius:5px;
      font-size:11px;
      font-weight:700;
      border:1px solid;
      text-transform:uppercase;
      letter-spacing:.3px
    }

    .badge-primary{
      background:rgba(220,38,38,.15);
      border-color:var(--primary);
      color:var(--primary-light)
    }

    .badge-success{
      background:rgba(34,197,94,.15);
      border-color:var(--success);
      color:var(--success)
    }

    .badge-warning{
      background:rgba(245,158,11,.15);
      border-color:var(--warning);
      color:var(--warning)
    }

    .badge-danger{
      background:rgba(220,38,38,.15);
      border-color:var(--danger);
      color:var(--danger)
    }

    .badge-info{
      background:rgba(99,102,241,.15);
      border-color:var(--info);
      color:var(--info)
    }

    /* BUTTONS */
    .btn{
      padding:10px 18px;
      border-radius:7px;
      border:1px solid;
      font-weight:600;
      cursor:pointer;
      transition:all .2s cubic-bezier(0.4,0,0.2,1);
      font-size:13px;
      text-align:center;
      display:inline-block;
      background:transparent
    }

    .btn-primary{
      background:linear-gradient(135deg,var(--primary),var(--primary-light));
      border-color:var(--primary);
      color:#fff;
      box-shadow:0 4px 12px rgba(220,38,38,.2)
    }

    .btn-primary:hover{
      transform:translateY(-2px);
      box-shadow:0 6px 16px rgba(220,38,38,.3)
    }

    .btn-success{
      background:var(--success);
      border-color:var(--success);
      color:#fff
    }
    
    .btn-success:hover{
      transform:translateY(-2px);
      box-shadow:0 4px 12px rgba(34,197,94,.3)
    }

    .btn-danger{
      background:var(--danger);
      border-color:var(--danger);
      color:#fff
    }

    .btn-ghost{
      background:transparent;
      border-color:var(--border);
      color:var(--text)
    }

    .btn-ghost:hover{
      background:var(--card);
      border-color:var(--border-light)
    }

    .btn-lg{
      padding:12px 24px;
      font-size:14px;
      width:100%
    }

    .btn:disabled{
      opacity:.5;
      cursor:not-allowed
    }

    /* FORMS */
    .form-group{
      margin-bottom:16px
    }

    .form-label{
      display:block;
      font-weight:600;
      margin-bottom:6px;
      font-size:13px;
      color:var(--text);
      letter-spacing:.3px
    }

    .form-input,
    .form-select,
    .form-textarea{
      width:100%;
      background:var(--bg-light);
      border:1px solid var(--border);
      color:var(--text);
      padding:10px 12px;
      border-radius:7px;
      font-size:13px;
      transition:all .2s;
      font-family:inherit;
      max-width:100%
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus{
      outline:none;
      border-color:var(--primary);
      box-shadow:0 0 0 3px rgba(220,38,38,.1)
    }

    .form-textarea{
      min-height:100px;
      resize:vertical
    }

    .form-hint{
      font-size:11px;
      color:var(--text-muted);
      margin-top:4px;
      font-weight:500
    }

    .form-row{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
      gap:16px;
      width:100%
    }

    .checkbox-label{
      display:flex;
      align-items:flex-start;
      gap:10px;
      padding:12px;
      background:var(--bg-light);
      border:1px solid var(--border);
      border-radius:7px;
      cursor:pointer;
      transition:all .2s;
      width:100%
    }
    
    .checkbox-label:hover{
      border-color:var(--border-light);
      background:var(--card)
    }

    .checkbox-label input{
      margin-top:2px
    }

    /* GRID */
    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(280px,1fr));
      gap:14px;
      width:100%
    }

    @media (max-width:768px){
      .grid{
        grid-template-columns:1fr;
        gap:12px
      }
    }

    /* FILTERS */
    .filters{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:16px;
      margin-bottom:16px;
      width:100%
    }

    /* ALERT */
    .alert{
      padding:12px 16px;
      border-radius:7px;
      margin-bottom:16px;
      border:1px solid;
      font-size:13px;
      font-weight:500;
      width:100%
    }

    .alert-info{
      background:rgba(99,102,241,.1);
      border-color:var(--info);
      color:var(--text)
    }

    .alert-warning{
      background:rgba(245,158,11,.1);
      border-color:var(--warning);
      color:var(--text)
    }

    .alert-success{
      background:rgba(34,197,94,.1);
      border-color:var(--success);
      color:var(--text)
    }

    /* MODAL */
    .modal-overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.85);
      backdrop-filter:blur(4px);
      z-index:999;
      display:none;
      align-items:center;
      justify-content:center;
      padding:20px;
      animation:fadeIn .2s ease
    }

    @keyframes fadeIn{
      from{opacity:0}
      to{opacity:1}
    }

    .modal-overlay.show{
      display:flex
    }

    .modal{
      background:var(--card);
      border:1px solid var(--border-light);
      border-radius:var(--radius);
      padding:20px;
      max-width:600px;
      width:100%;
      max-height:90vh;
      overflow-y:auto;
      box-shadow:var(--shadow-lg);
      animation:slideUp .3s ease
    }

    @keyframes slideUp{
      from{
        opacity:0;
        transform:translateY(20px)
      }
      to{
        opacity:1;
        transform:translateY(0)
      }
    }

    .modal-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:16px;
      padding-bottom:12px;
      border-bottom:1px solid var(--border)
    }

    .modal-title{
      font-size:18px;
      font-weight:700;
      letter-spacing:-.5px
    }

    .modal-close{
      background:transparent;
      border:none;
      font-size:24px;
      cursor:pointer;
      color:var(--text-muted);
      padding:0;
      width:32px;
      height:32px;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:6px;
      transition:all .2s
    }
    
    .modal-close:hover{
      background:var(--bg-light);
      color:var(--text)
    }

    /* TRADE REQUEST */
    .trade-request{
      background:var(--bg-light);
      border:1px solid var(--border);
      border-radius:8px;
      padding:14px;
      margin-bottom:12px;
      transition:all .2s;
      width:100%
    }
    
    .trade-request:hover{
      border-color:var(--border-light)
    }

    .trade-status{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:5px 10px;
      border-radius:6px;
      font-size:11px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:.3px
    }

    .trade-status.pending{
      background:rgba(245,158,11,.15);
      color:var(--warning)
    }

    .trade-status.verifying{
      background:rgba(99,102,241,.15);
      color:var(--info)
    }

    .trade-status.accepted{
      background:rgba(34,197,94,.15);
      color:var(--success)
    }

    .trade-status.rejected{
      background:rgba(220,38,38,.15);
      color:var(--danger)
    }

    .spot-selector{
      background:var(--bg-light);
      border:1px solid var(--border);
      border-radius:7px;
      padding:12px;
      margin-bottom:10px;
      cursor:pointer;
      transition:border-color .2s ease;
      display:flex;
      align-items:flex-start;
      gap:12px;
      width:100%
    }

    .spot-selector:hover{
      border-color:var(--border-light)
    }

    .spot-selector.selected{
      border-color:var(--primary);
      background:rgba(220,38,38,.05)
    }

    .spot-selector input[type="checkbox"],
    .spot-selector input[type="radio"]{
      margin-top:4px;
      flex-shrink:0
    }
    
    .spot-selector-content{
      flex:1;
      min-width:0
    }

    /* COORDINATES REVEAL */
    .coordinates-box{
      background:linear-gradient(135deg,var(--success),#16a34a);
      color:#fff;
      padding:14px;
      border-radius:8px;
      margin:12px 0;
      font-family:monospace;
      font-size:13px;
      box-shadow:0 4px 12px rgba(34,197,94,.2);
      width:100%
    }

    .coordinates-box strong{
      display:block;
      margin-bottom:6px;
      font-size:14px;
      font-weight:700
    }

    /* TOAST */
    .toast{
      position:fixed;
      bottom:24px;
      right:24px;
      background:var(--card);
      border:1px solid var(--border-light);
      color:var(--text);
      padding:14px 18px;
      border-radius:8px;
      box-shadow:var(--shadow-lg);
      z-index:1000;
      display:none;
      min-width:250px;
      font-size:13px;
      font-weight:600;
      animation:slideInRight .3s ease
    }

    @keyframes slideInRight{
      from{
        opacity:0;
        transform:translateX(100px)
      }
      to{
        opacity:1;
        transform:translateX(0)
      }
    }

    .toast.show{display:block}

    .toast.success{
      border-color:var(--success);
      background:rgba(34,197,94,.15);
      color:var(--success)
    }

    .toast.error{
      border-color:var(--danger);
      background:rgba(220,38,38,.15);
      color:var(--danger)
    }

    /* UTILITY */
    .hidden{display:none!important}
    .text-center{text-align:center}
    .text-muted{color:var(--text-muted)}
    .mt-2{margin-top:12px}
    .mb-2{margin-bottom:12px}
    .flex{display:flex}
    .flex-between{display:flex;justify-content:space-between;align-items:center}
    .gap-2{gap:12px}

    h2{
      font-size:22px;
      margin-bottom:6px;
      font-weight:700;
      letter-spacing:-.5px
    }

    h3{
      font-size:16px;
      margin-bottom:10px;
      font-weight:700;
      letter-spacing:-.3px
    }

    .section-header{
      margin-bottom:16px;
      width:100%
    }

    .empty-state{
      text-align:center;
      padding:40px 20px;
      color:var(--text-muted);
      width:100%
    }

    .empty-state-icon{
      font-size:40px;
      margin-bottom:12px;
      opacity:.6
    }

    /* TABS */
    .tabs{
      display:flex;
      gap:6px;
      margin-bottom:16px;
      border-bottom:1px solid var(--border);
      overflow-x:auto;
      padding-bottom:2px;
      width:100%;
      -webkit-overflow-scrolling:touch;
      scrollbar-width:none
    }
    
    .tabs::-webkit-scrollbar{
      display:none
    }

    .tab{
      padding:10px 16px;
      background:transparent;
      border:none;
      color:var(--text-muted);
      cursor:pointer;
      border-bottom:2px solid transparent;
      transition:all .2s;
      font-weight:600;
      white-space:nowrap;
      flex-shrink:0;
      font-size:13px
    }

    .tab:hover{
      color:var(--text)
    }

    .tab.active{
      color:var(--primary);
      border-bottom-color:var(--primary)
    }

    /* MAP VIEW - FIXED FOR MOBILE */
    .map-container{
      background:var(--bg-light);
      border-radius:var(--radius);
      overflow:hidden;
      position:relative;
      width:100%;
      height:500px;
      margin-bottom:0;
      display:flex;
      flex-direction:column
    }
    
    #map {
      flex:1;
      width:100%;
      border-radius:var(--radius);
      z-index:1;
      min-height:300px;
      position:relative
    }
    
    .leaflet-container {
      background: var(--bg-light) !important;
      font-family: inherit !important;
      width:100% !important;
      height:100% !important;
      position:absolute !important;
      top:0 !important;
      left:0 !important;
      right:0 !important;
      bottom:0 !important
    }
    
    .leaflet-popup-content {
      color: var(--text) !important;
      background: var(--card) !important;
      font-size:12px !important
    }
    
    .leaflet-popup-content-wrapper {
      background: var(--card) !important;
      border: 1px solid var(--border) !important;
      color: var(--text) !important;
      border-radius: 8px !important;
      padding:8px !important;
      max-width:250px !important
    }
    
    .leaflet-popup-tip {
      background: var(--card) !important;
      border: 1px solid var(--border) !important
    }
    
    .leaflet-control-attribution {
      background: rgba(0,0,0,0.7) !important;
      color: var(--text-muted) !important;
      font-size:10px !important;
      padding:2px 5px !important
    }
    
    .leaflet-control-attribution a {
      color: var(--primary-light) !important;
      font-size:10px !important
    }
    
    .leaflet-control-zoom a {
      background: var(--card) !important;
      color: var(--text) !important;
      border-color: var(--border) !important;
      width:30px !important;
      height:30px !important;
      line-height:30px !important
    }
    
    .leaflet-control-zoom a:hover {
      background: var(--card-hover) !important
    }
    
    .leaflet-control-zoom {
      border:none !important;
      box-shadow:var(--shadow) !important;
      border-radius:5px !important;
      overflow:hidden
    }
    
    /* Map controls container - FIXED FOR MOBILE */
    .map-controls-container {
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      justify-content:center;
      padding:10px;
      margin-top:0;
      background:var(--card);
      border-top:1px solid var(--border);
      position:relative;
      z-index:10;
      overflow:hidden;
      width:100%
    }
    
    .map-controls-container .btn {
      padding:8px 10px;
      font-size:12px;
      flex:1;
      min-width:140px;
      max-width:180px;
      white-space:nowrap
    }
    
    /* Map controls grid layout */
    .map-controls-grid {
      display:grid;
      grid-template-columns:repeat(2, 1fr);
      gap:6px;
      width:100%
    }
    
    .map-controls-grid .btn {
      width:100%;
      min-width:0;
      max-width:100%;
      padding:8px 6px;
      font-size:11px
    }

    /* PROFILE STATS */
    .profile-stats{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(120px, 1fr));
      gap:12px;
      margin-bottom:20px;
      width:100%
    }
    
    .stat-card{
      background:var(--bg-light);
      border:1px solid var(--border);
      border-radius:8px;
      padding:16px;
      text-align:center;
      width:100%
    }
    
    .stat-value{
      font-size:24px;
      font-weight:700;
      color:var(--primary);
      margin-bottom:4px
    }
    
    .stat-label{
      font-size:12px;
      color:var(--text-muted);
      text-transform:uppercase;
      letter-spacing:.5px
    }

    /* PROFILE SETTINGS */
    .settings-grid{
      display:grid;
      grid-template-columns:1fr;
      gap:16px;
      width:100%
    }
    
    .setting-item{
      background:var(--bg-light);
      border:1px solid var(--border);
      border-radius:8px;
      padding:16px;
      width:100%
    }
    
    .setting-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:12px;
      width:100%
    }
    
    .setting-title{
      font-size:14px;
      font-weight:600;
      color:var(--text)
    }
    
    .setting-description{
      font-size:12px;
      color:var(--text-muted);
      line-height:1.4
    }
    
    .setting-control{
      margin-top:12px;
      width:100%
    }
    
    .setting-switch{
      display:flex;
      align-items:center;
      gap:10px
    }
    
    .switch{
      position:relative;
      display:inline-block;
      width:50px;
      height:26px
    }
    
    .switch input{
      opacity:0;
      width:0;
      height:0
    }
    
    .slider{
      position:absolute;
      cursor:pointer;
      top:0;
      left:0;
      right:0;
      bottom:0;
      background-color:var(--border);
      transition:.4s;
      border-radius:34px
    }
    
    .slider:before{
      position:absolute;
      content:"";
      height:18px;
      width:18px;
      left:4px;
      bottom:4px;
      background-color:#fff;
      transition:.4s;
      border-radius:50%
    }
    
    input:checked + .slider{
      background-color:var(--primary)
    }
    
    input:checked + .slider:before{
      transform:translateX(24px)
    }

    /* ACTION BUTTONS FOR SPOTS */
    .spot-actions{
      display:flex;
      gap:8px;
      margin-top:12px;
      flex-wrap:wrap;
      width:100%
    }
    
    .spot-actions .btn{
      flex:1;
      min-width:120px;
      padding:8px 12px;
      font-size:12px
    }

    /* ADMIN STYLES */
    .admin-container {
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 20px
    }
    
    .admin-stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 25px
    }
    
    .admin-stat-card {
      background: var(--card);
      padding: 15px;
      border-radius: 8px;
      border: 1px solid var(--border);
      text-align: center
    }
    
    .admin-section {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px
    }
    
    .admin-small-stat {
      font-size: 20px !important;
      font-weight: 700;
      margin-bottom: 4px
    }

    .spot-list-item {
      background: var(--bg-light);
      border: 1px solid var(--border);
      border-radius: 7px;
      padding: 12px;
      margin-bottom: 10px;
      transition: all .2s
    }
    
    .spot-list-item:hover {
      border-color: var(--border-light);
      background: var(--card)
    }
    
    .spot-list-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px
    }
    
    .spot-list-actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap
    }
    
    .spot-list-actions .btn {
      padding: 5px 10px;
      font-size: 11px
    }
    
    .trade-details-box {
      background: var(--bg-light);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      margin: 10px 0
    }
    
    .trade-spot-info {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 10px;
      margin: 6px 0
    }
    
    .admin-action-buttons {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap
    }

    .user-list-item {
      background: var(--bg-light);
      border: 1px solid var(--border);
      border-radius: 7px;
      padding: 12px;
      margin-bottom: 10px;
      transition: all .2s
    }
    
    .user-list-item:hover {
      border-color: var(--border-light);
      background: var(--card)
    }

    .invite-list-item {
      background: var(--bg-light);
      border: 1px solid var(--border);
      border-radius: 7px;
      padding: 12px;
      margin-bottom: 10px;
      font-size: 12px
    }
    
    .invite-status {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase
    }
    
    .invite-status.active {
      background: rgba(34,197,94,.15);
      color: var(--success)
    }
    
    .invite-status.used {
      background: rgba(99,102,241,.15);
      color: var(--info)
    }

    .url-box {
      background: var(--bg-light);
      border: 1px solid var(--border);
      border-radius: 7px;
      padding: 12px;
      margin-top: 10px;
      font-size: 12px;
      word-break: break-all;
      cursor: pointer;
      transition: all .2s
    }
    
    .url-box:hover {
      background: var(--card);
      border-color: var(--primary)
    }

    .file-upload-area {
      border: 2px dashed var(--border);
      border-radius: 8px;
      padding: 30px;
      text-align: center;
      cursor: pointer;
      transition: all .2s;
      background: var(--bg-light)
    }
    
    .file-upload-area:hover {
      border-color: var(--primary);
      background: var(--card)
    }
    
    .file-upload-area.drag-over {
      border-color: var(--primary);
      background: rgba(220,38,38,.05)
    }

    /* RESPONSIVE */
    @media (max-width:768px){
      .header-content{
        flex-direction:column;
        align-items:flex-start;
        padding:10px 16px;
        gap:10px;
        max-width:100%
      }
      
      .logo-area{
        width:100%
      }
      
      .logo{
        width:36px;
        height:36px
      }
      
      .brand h1{
        font-size:16px
      }
      
      .brand p{
        font-size:10px
      }
      
      .brand .gang-name{
        font-size:9px
      }
      
      nav{
        width:100%;
        overflow-x:auto;
        padding-bottom:6px;
        justify-content:flex-start;
        -webkit-overflow-scrolling:touch;
        scrollbar-width:none
      }
      
      nav::-webkit-scrollbar{
        display:none
      }
      
      .nav-btn{
        padding:7px 12px;
        font-size:12px;
        flex-shrink:0
      }
      
      .nav-btn .badge-count{
        position:relative;
        top:0;
        right:0;
        margin-left:4px;
        display:inline-block
      }

      .container{
        padding:14px;
        max-width:100%;
        width:100%;
        overflow-x:hidden
      }
      
      .form-row{
        grid-template-columns:1fr
      }

      .toast{
        left:14px;
        right:14px;
        bottom:14px;
        min-width:auto;
        max-width:calc(100vw - 28px)
      }
      
      .grid{
        grid-template-columns:1fr;
        gap:10px
      }
      
      .card{
        padding:16px;
        margin-bottom:12px
      }
      
      .spot-card{
        padding:14px
      }
      
      .modal{
        padding:18px 14px;
        margin:10px;
        max-height:85vh;
        max-width:calc(100vw - 20px)
      }
      
      .section-header h2{
        font-size:20px
      }
      
      .filters{
        padding:14px
      }
      
      .spot-title{
        font-size:14px
      }
      
      .spot-meta{
        font-size:11px
      }
      
      .map-container {
        height:400px !important;
        min-height:300px;
        max-height:500px;
        margin-bottom:0;
        border-radius:8px;
        overflow:hidden;
        width:100% !important;
        position:relative
      }
      
      #map {
        height:100% !important;
        min-height:300px;
        position:absolute !important
      }
      
      .leaflet-container {
        height:100% !important;
        min-height:300px;
        width:100% !important;
        position:absolute !important;
        top:0 !important;
        left:0 !important;
        right:0 !important;
        bottom:0 !important
      }
      
      .leaflet-control-zoom a {
        width:36px !important;
        height:36px !important;
        line-height:36px !important;
        font-size:18px !important
      }
      
      .map-controls-container {
        padding:10px;
        gap:6px;
        flex-wrap:wrap;
        width:100%
      }
      
      .map-controls-container .btn {
        padding:8px 8px;
        font-size:11px;
        min-width:calc(50% - 8px);
        max-width:calc(50% - 8px);
        flex:1 1 auto
      }
      
      .map-controls-grid {
        grid-template-columns:repeat(2, 1fr);
        gap:6px;
        width:100%
      }
      
      .profile-stats{
        grid-template-columns:repeat(2, 1fr);
        gap:10px
      }
      
      .spot-actions .btn{
        min-width:calc(50% - 4px)
      }
      
      .settings-grid{
        grid-template-columns:1fr;
        gap:12px
      }
      
      .stat-card{
        padding:12px
      }
      
      .stat-value{
        font-size:20px
      }
      
      .tabs{
        overflow-x:auto;
        scrollbar-width:none;
        padding-bottom:0;
        width:100%
      }
      
      .tabs::-webkit-scrollbar{
        display:none
      }
      
      .tab{
        padding:8px 12px;
        font-size:12px;
        white-space:nowrap
      }
    }
    
    @media (max-width:480px){
      .logo{
        width:32px;
        height:32px
      }
      
      .brand h1{
        font-size:15px
      }
      
      .nav-btn{
        padding:6px 10px;
        font-size:11px
      }
      
      .tabs{
        gap:4px
      }
      
      .tab{
        padding:8px 12px;
        font-size:12px
      }
      
      .spot-exchange{
        padding:8px;
        font-size:12px
      }
      
      .profile-stats{
        grid-template-columns:1fr;
        gap:8px
      }
      
      .spot-actions .btn{
        min-width:100%
      }
      
      .map-container {
        height:350px !important;
        min-height:250px;
        max-height:400px;
        width:100% !important
      }
      
      #map {
        min-height:250px;
        position:absolute !important
      }
      
      .leaflet-container {
        min-height:250px;
        position:absolute !important;
        top:0 !important;
        left:0 !important;
        right:0 !important;
        bottom:0 !important
      }
      
      .map-controls-container {
        flex-direction:row;
        flex-wrap:wrap;
        align-items:stretch;
        gap:6px;
        padding:8px;
        width:100%
      }
      
      .map-controls-container .btn {
        min-width:calc(50% - 6px) !important;
        max-width:calc(50% - 6px) !important;
        padding:8px 4px;
        font-size:11px;
        flex:1 1 auto
      }
      
      .map-controls-grid {
        grid-template-columns:repeat(2, 1fr);
        gap:6px;
        width:100%
      }
      
      .leaflet-popup-content-wrapper {
        max-width:200px !important;
        padding:6px !important
      }
      
      .leaflet-popup-content {
        font-size:11px !important;
        line-height:1.3 !important
      }
    }
    
    @media (max-width:320px){
      .map-container {
        height:300px !important;
        min-height:200px;
        max-height:350px;
        width:100% !important
      }
      
      #map {
        min-height:200px
      }
      
      .leaflet-container {
        min-height:200px
      }
      
      .map-controls-container {
        padding:6px;
        flex-direction:column
      }
      
      .map-controls-container .btn {
        min-width:100% !important;
        max-width:100% !important;
        padding:8px 6px;
        font-size:10px
      }
      
      .map-controls-grid {
        grid-template-columns:1fr;
        gap:6px
      }
    }
    
    #tab-map {
      width: 100%;
      max-width: 100%;
      overflow: hidden;
      position: relative
    }
    
    #tab-map .map-container {
      width: 100% !important;
      max-width: 100% !important
    }
    
    section[id^="view-"] {
      width: 100%;
      max-width: 100%;
      overflow-x: hidden;
      position: relative
    }

    ::-webkit-scrollbar{
      width:8px;
      height:8px
    }

    ::-webkit-scrollbar-track{
      background:var(--bg-light)
    }

    ::-webkit-scrollbar-thumb{
      background:var(--border);
      border-radius:4px
    }

    ::-webkit-scrollbar-thumb:hover{
      background:var(--border-light)
    }
    
    main, .container, section, .grid, .card, .spot-card {
      max-width: 100%;
      overflow-x: hidden
    }
    
    img, video, iframe {
      max-width: 100%;
      height: auto
    }

    /* LOGIN STYLES */
    #login-screen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--bg);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px
    }
    
    .login-container {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 40px;
      max-width: 400px;
      width: 100%;
      text-align: center
    }
    
    .login-logo {
      margin-bottom: 30px
    }
    
    .login-logo h1 {
      font-size: 28px;
      margin-bottom: 8px
    }
    
    .login-test-accounts {
      margin-top: 20px;
      padding: 15px;
      background: var(--bg-light);
      border-radius: 8px;
      font-size: 12px
    }
    
    .login-error {
      color: var(--danger);
      background: rgba(220,38,38,.1);
      border: 1px solid var(--danger);
      border-radius: 6px;
      padding: 10px;
      margin-bottom: 20px;
      display: none
    }
    
    #register-screen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--bg);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px
    }
    
    #code-input-screen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--bg);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1001;
      padding: 20px;
      width: 100vw;
      height: 100vh;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    .code-input-modal {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 30px;
      max-width: 400px;
      width: 100%;
      text-align: center;
      box-shadow: var(--shadow-lg);
      margin: auto;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .code-input-field {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: 4px;
      text-align: center;
      text-transform: uppercase;
      width: 100%;
      padding: 15px;
      background: var(--bg-light);
      border: 2px solid var(--border);
      border-radius: 8px;
      color: var(--text);
    }
    
    .code-input-field:focus {
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.2);
    }
    
    .code-hint {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 8px;
      display: block;
    }
    
    .code-success {
      color: var(--success);
      font-size: 14px;
      font-weight: 600;
      margin-top: 15px;
      padding: 10px;
      background: rgba(34, 197, 94, 0.1);
      border-radius: 6px;
      border: 1px solid var(--success);
    }
    
    /* Responsive fixes */
    @media (max-width: 768px) {
      #code-input-screen {
        padding: 10px;
        align-items: flex-start;
        padding-top: 20px;
      }
      
      .code-input-modal {
        padding: 20px;
        margin: 10px;
        max-height: 85vh;
      }
      
      .code-input-field {
        font-size: 18px;
        letter-spacing: 2px;
        padding: 12px;
      }
    }
    
    @media (max-width: 480px) {
      .code-input-modal {
        padding: 15px;
      }
      
      .code-input-field {
        font-size: 16px;
        letter-spacing: 1px;
      }
    }

    .expandable-spots {
      margin-top: 10px;
    }

    .expandable-header {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 10px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all .2s;
    }

    .expandable-header:hover {
      border-color: var(--primary);
      background: var(--card-hover);
    }

    .expandable-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height .3s ease;
    }

    .expandable-content.expanded {
      max-height: 2000px;
    }

    .offered-spot-detail {
      background: var(--bg-light);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 10px;
      margin-top: 8px;
    }
    /* FIX PER SCROLL ORIZZONTALE MOBILE */
    html, body {
      max-width: 100%;
      overflow-x: hidden;
      position: relative;
      -webkit-overflow-scrolling: touch;
    }
    
    body {
      overscroll-behavior: none;
      -webkit-overflow-scrolling: touch;
      overflow-x: hidden !important;
    }
    
    /* Previeni lo scroll orizzontale su tutti gli elementi */
    .container, main, section, .grid, .card, .spot-card {
      max-width: 100vw;
      overflow-x: hidden !important;
      position: relative;
    }
    
    /* Fix per elementi che potrebbero causare scroll orizzontale */
    img, video, iframe, canvas {
      max-width: 100% !important;
      height: auto !important;
    }
    
    /* Previeni lo spostamento laterale su iOS */
    @supports (-webkit-touch-callout: none) {
      body {
        position: fixed;
        width: 100%;
        height: 100%;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }
    }
    
    /* Disabilita lo scroll orizzontale sui contenitori */
    #market-grid, #published-spots-grid, #acquired-spots-grid {
      overflow-x: hidden !important;
    }
    
    /* Fix per i pulsanti di navigazione */
    nav {
      overflow-x: auto !important;
      overflow-y: hidden !important;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    /* Aggiungi questo nuovo stile */
    nav {
      position: relative;
    }
    

    nav::-webkit-scrollbar {
      display: none;
    }
    /* FIX PER MOBILE: Prevenire tocchi accidentali e migliorare responsiveness */
@media (max-width: 768px) {
  .nav-btn {
    -webkit-tap-highlight-color: rgba(0,0,0,0);
    -webkit-tap-highlight-color: transparent;
    user-select: none;
    touch-action: manipulation;
  }
  
  /* Migliora la risposta al tocco */
  .nav-btn:active {
    transform: scale(0.98);
    transition: transform 0.1s;
  }
  
  /* Assicura che i bottoni non abbiano margini negativi */
  .header-content {
    padding: 8px 12px !important;
  }
  
  nav {
    margin-left: -4px;
    margin-right: -4px;
    padding-left: 4px;
    padding-right: 4px;
  }
  
  .nav-btn {
    margin: 0 2px;
  }
  
  /* Fix per il profilo utente su mobile */
  #user-profile-display {
    min-width: 100px;
  }
  
  #user-display-name {
    font-size: 11px !important;
    max-width: 60px;
    overflow: hidden;
    text-overflow: ellipsis;
  }
}

/* Fix per dispositivi molto piccoli */
@media (max-width: 360px) {
  .brand h1 {
    font-size: 15px !important;
  }
  
  .brand p {
    font-size: 9px !important;
  }
  
  .nav-btn {
    font-size: 11px !important;
    padding: 6px 4px !important;
  }
  
  #user-display-name {
    font-size: 10px !important;
    max-width: 50px;
  }
  
  #user-avatar {
    width: 28px !important;
    height: 28px !important;
    font-size: 11px !important;
  }
}
    /* CONTENT CREATOR STYLES */
.creator-badge {
  background: linear-gradient(135deg, #f59e0b, #d97706);
  color: white;
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 10px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  display: inline-flex;
  align-items: center;
  gap: 4px;
  margin-left: 6px;
}

.creator-spot-card {
  border: 2px solid #f59e0b !important;
  box-shadow: 0 0 12px rgba(245, 158, 11, 0.3) !important;
  background: linear-gradient(135deg, rgba(245, 158, 11, 0.05), transparent) !important;
}

.creator-spot-card::before {
  background: linear-gradient(90deg, #f59e0b, #d97706) !important;
  opacity: 1 !important;
}

.creator-name {
  color: #f59e0b !important;
  font-weight: 700 !important;
  text-shadow: 0 0 8px rgba(245, 158, 11, 0.3);
}
    /* USER LEVEL STYLES */
.level-badge {
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 9px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-left: 4px;
  display: inline-block;
}

.level-1 { background: #6b7280; color: white; } /* 1 spot - Grigio */
.level-2 { background: #3b82f6; color: white; } /* 5 spot - Blu */
.level-3 { background: #8b5cf6; color: white; } /* 10 spot - Viola */
.level-4 { background: #ec4899; color: white; } /* 15 spot - Rosa */
.level-5 { background: #f59e0b; color: white; } /* 30 spot - Arancione */
.level-6 { background: #ef4444; color: white; } /* 50 spot - Rosso */
.level-7 { background: linear-gradient(135deg, #fbbf24, #f59e0b); color: white; } /* 100+ spot - Oro */

.user-level-1 { color: #9ca3af !important; }
.user-level-2 { color: #60a5fa !important; }
.user-level-3 { color: #a78bfa !important; }
.user-level-4 { color: #f472b6 !important; }
.user-level-5 { color: #fbbf24 !important; }
.user-level-6 { color: #f87171 !important; }
.user-level-7 { 
  background: linear-gradient(135deg, #fbbf24, #f59e0b);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  font-weight: 800 !important;
}
  </style>
</head>
<body>
  <!-- LOADING OVERLAY -->
  <div id="loading-overlay" class="loading-overlay">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <div class="loading-text">Caricamento...</div>
    </div>
  </div>

  <!-- LOGIN SCREEN -->  
  <div id="login-screen">
    <div class="login-container">
      <div class="login-logo">
        <h1>SpotSwap</h1>
        <p class="text-muted">Scambia spot</p>
        <div style="color: var(--primary); font-size: 12px; font-weight: 600; margin-top: 4px;">
          2Lost2Find Gang
        </div>
      </div>
      
      <div id="login-error" class="login-error"></div>
      
      <div class="form-group">
        <input type="text" id="login-username" class="form-input" placeholder="Username">
      </div>
      
      <div class="form-group">
        <input type="password" id="login-password" class="form-input" placeholder="Password">
      </div>
      
      <button class="btn btn-primary btn-lg" id="login-button" style="width: 100%;">
        Accedi
      </button>
      
      <button class="btn btn-ghost" onclick="showCodeInput()" style="width: 100%; margin-top: 15px;">
        Ho un codice
      </button>
    </div>
  </div>

  <!-- CODE INPUT MODAL -->
  <div id="code-input-screen" style="display: none;">
    <div class="code-input-modal">
      <div class="login-logo">
        <h1>Inserisci codice</h1>
        <p class="text-muted">Inserisci il codice di registrazione</p>
      </div>
      
      <div id="code-error" class="login-error"></div>
      
      <div class="form-group">
        <input type="text" id="code-input" class="form-input code-input-field" placeholder="XXXX-XXXX-XXXX" maxlength="14">
        <div class="code-hint">Formato: XXXX-XXXX-XXXX</div>
      </div>
      
      <div id="code-success" class="code-success" style="display: none;"></div>
      
      <div class="form-group">
        <label class="form-label">Scegli il tuo username</label>
        <input type="text" id="code-username" class="form-input" placeholder="Username unico">
      </div>
      
      <div class="form-group">
        <label class="form-label">Password</label>
        <input type="password" id="code-password" class="form-input" placeholder="Minimo 6 caratteri">
      </div>
      
      <div class="form-group">
        <label class="form-label">Conferma Password</label>
        <input type="password" id="code-confirm-password" class="form-input" placeholder="Ripeti la password">
      </div>
      
      <button class="btn btn-primary btn-lg" onclick="handleCodeRegistration()" style="width: 100%; margin-bottom: 15px;">
        Registrati con codice
      </button>
      
      <button class="btn btn-ghost" onclick="showLoginFromCode()" style="width: 100%;">
        Torna al Login
      </button>
    </div>
  </div>

  <!-- ADMIN PANEL -->
  <div id="admin-panel" class="admin-container" style="display: none;">
    <div style="max-width: 1400px; margin: 0 auto;">
      <div class="flex-between" style="margin-bottom: 30px;">
        <h1 style="font-size: 24px; font-weight: 700;">SpotSwap Admin Panel</h1>
        <div style="display: flex; gap: 10px;">
          <button class="btn btn-primary" onclick="loadAdminData()">ðŸ”„ Aggiorna</button>
          <button class="btn btn-danger" onclick="logout()">Logout</button>
        </div>
      </div>
      
      <div id="admin-stats" class="admin-stats-grid"></div>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 30px;">
        <!-- GENERATE INVITE CODE -->
        <div class="admin-section">
          <h2 style="margin-bottom: 15px; font-size: 18px;">ðŸ”— Genera Codice per Fan</h2>
          <button class="btn btn-primary" onclick="generateInviteCode()" style="width: 100%; margin-bottom: 15px;">
            Genera Codice di Registrazione
          </button>
          <div id="invite-result" style="display: none; margin-top: 10px;"></div>
        </div>
        
        <!-- CREATE SPOT AS USER -->
        <div class="admin-section">
          <h2 style="margin-bottom: 15px; font-size: 18px;">ðŸ“ Crea Spot come Utente</h2>
          <div class="form-group">
            <label class="form-label">Nome Utente</label>
            <input type="text" id="spot-username" class="form-input" placeholder="es: FanDi2Lost2Find">
          </div>
          <div class="form-group">
            <label class="form-label">Offre</label>
            <input type="text" id="spot-give" class="form-input" placeholder="es: Ex fabbrica tessile">
          </div>
          <div class="form-group">
            <label class="form-label">Cerca</label>
            <input type="text" id="spot-want" class="form-input" placeholder="es: Hotel abbandonato">
          </div>
          <div class="form-group">
            <label class="form-label">Regione</label>
            <select class="form-select" id="spot-region-admin">
              <option value="">Seleziona regione...</option>
              <option value="Abruzzo">Abruzzo</option>
              <option value="Basilicata">Basilicata</option>
              <option value="Calabria">Calabria</option>
              <option value="Campania">Campania</option>
              <option value="Emilia-Romagna">Emilia-Romagna</option>
              <option value="Friuli-Venezia Giulia">Friuli-Venezia Giulia</option>
              <option value="Lazio">Lazio</option>
              <option value="Liguria">Liguria</option>
              <option value="Lombardia">Lombardia</option>
              <option value="Marche">Marche</option>
              <option value="Molise">Molise</option>
              <option value="Piemonte">Piemonte</option>
              <option value="Puglia">Puglia</option>
              <option value="Sardegna">Sardegna</option>
              <option value="Sicilia">Sicilia</option>
              <option value="Toscana">Toscana</option>
              <option value="Trentino-Alto Adige">Trentino-Alto Adige</option>
              <option value="Umbria">Umbria</option>
              <option value="Valle d'Aosta">Valle d'Aosta</option>
              <option value="Veneto">Veneto</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Categoria</label>
            <select class="form-select" id="spot-category-admin">
              <option value="industriale">Industriale</option>
              <option value="hotel">Hotel</option>
              <option value="villa">Villa</option>
              <option value="sanitario">Sanitario</option>
              <option value="militare">Militare</option>
              <option value="altro">Altro</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Coordinate GPS</label>
            <input type="text" id="spot-coordinates-admin" class="form-input" placeholder="es: 45.4642, 9.1900">
          </div>
          <div class="form-group">
            <label class="form-label">Descrizione</label>
            <textarea class="form-textarea" id="spot-description-admin" rows="3" placeholder="Descrizione dello spot..."></textarea>
          </div>
          <button class="btn btn-success" onclick="createAdminSpot()" style="width: 100%; margin-bottom: 10px;">
            Crea Spot Singolo
          </button>
          
          <!-- Import spots from file -->
          <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border);">
            <h3 style="font-size: 14px; margin-bottom: 10px;">Importa Spot da File</h3>
            <div class="file-upload-area" id="file-upload-area">
              <div style="font-size: 40px; margin-bottom: 10px;">ðŸ“</div>
              <div style="margin-bottom: 10px;">Trascina qui il file CSV o clicca per selezionare</div>
              <input type="file" id="file-input" accept=".csv" style="display: none;">
              <button class="btn btn-ghost" onclick="document.getElementById('file-input').click()">
                Seleziona File
              </button>
            </div>
            <div style="margin-top: 10px;">
              <a href="#" onclick="downloadTemplate()" class="btn btn-ghost" style="width: 100%;">
                ðŸ“¥ Scarica Template CSV
              </a>
            </div>
            <div id="import-status" style="margin-top: 10px; display: none;"></div>
          </div>
        </div>
      </div>
      
      <div class="tabs" style="margin-bottom: 20px;">
        <button class="tab active" data-admin-tab="trades">ðŸ”„ Scambi in Attesa</button>
        <button class="tab" data-admin-tab="spots">ðŸ“ Tutti gli Spot</button>
        <button class="tab" data-admin-tab="users">ðŸ‘¥ Utenti</button>
        <button class="tab" data-admin-tab="invites">ðŸ”— Codici</button>
      </div>
      
      <div id="admin-tab-trades" class="admin-section">
        <h2 style="margin-bottom: 15px; font-size: 20px;">Scambi in Attesa di Approvazione</h2>
        <div id="admin-trades-list"></div>
      </div>
      
      <div id="admin-tab-spots" class="admin-section hidden">
        <h2 style="margin-bottom: 15px; font-size: 20px;">Gestione Spot</h2>
        <div class="form-group" style="margin-bottom: 20px;">
          <input type="text" id="admin-spot-search" class="form-input" placeholder="Cerca spot..." oninput="searchAdminSpots()">
        </div>
        <div id="admin-spots-list"></div>
      </div>
      
      <div id="admin-tab-users" class="admin-section hidden">
        <h2 style="margin-bottom: 15px; font-size: 20px;">Gestione Utenti</h2>
        <div id="users-list"></div>
      </div>
      
      <div id="admin-tab-invites" class="admin-section hidden">
        <h2 style="margin-bottom: 15px; font-size: 20px;">Gestione Codici</h2>
        <div id="active-invites"></div>
      </div>
    </div>
  </div>

  <!-- MAIN APP -->
 <header>
  <div class="header-content">
    <div class="logo-area" style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
      <div style="display: flex; align-items: center; gap: 10px;">
        <div class="logo">
          <img src="https://yt3.ggpht.com/N4WaWTevD_K5buOS7rOYGHmwowNgBRTA0r6fF5vnylvLEUefL8G4ofnlh9LZ8th2TOrnt0gd-A=s176-c-k-c0x00ffffff-no-rj-mo" alt="2Lost2Find">
        </div>
        <div class="brand">
          <h1 style="font-size: 16px; margin-bottom: 2px;">SpotSwap</h1>
          <p style="font-size: 10px; margin-bottom: 0;">Scambia spot</p>
          <div class="gang-name">2Lost2Find Gang</div>
        </div>
      </div>

      <!-- Profilo utente sulla destra -->
      <div id="user-profile-display" style="display: none;">
        <div style="display: flex; align-items: center; gap: 6px;">
          <div style="text-align: right;">
            <div id="user-display-name" style="font-size: 12px; font-weight: 600; color: var(--text); white-space: nowrap;">User</div>
            <div style="font-size: 9px; color: var(--success); font-weight: 600; display: flex; align-items: center; gap: 2px; justify-content: flex-end;">
              <div style="width: 5px; height: 5px; background: var(--success); border-radius: 50%;"></div>
              online
            </div>
          </div>
          <div id="user-avatar" style="width: 32px; height: 32px; background: linear-gradient(135deg, var(--primary), var(--primary-light)); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 13px; border: 2px solid var(--border);">
            U
          </div>
        </div>
      </div>
    </div>

    <nav>
      <button class="nav-btn active" data-route="market">
        Mercato
      </button>
      <button class="nav-btn" data-route="requests">
        Scambi
        <span class="badge-count" id="requests-count">0</span>
      </button>
      <button class="nav-btn" data-route="my-spots">
        Area
      </button>
      <button class="nav-btn" data-route="new">
        + Nuovo
      </button>
    </nav>
  </div>
</header>
<!-- BANNER BETA TESTING -->
<div id="beta-banner" style="background: linear-gradient(90deg, #f59e0b, #d97706); color: white; padding: 6px 0; text-align: center; font-size: 11px; font-weight: 600; letter-spacing: 0.5px; border-bottom: 1px solid rgba(0,0,0,0.2); display: none;">
  ðŸš§ App in fase di beta testing - Potrebbero verificarsi problemi ðŸš§
</div>
  <!-- MAIN -->
  <main class="container">
    <!-- MARKET VIEW -->
    <section id="view-market">
      <div class="alert alert-info">
        <strong>ðŸ”’ Sistema sicuro</strong> â€” Coordinate visibili solo dopo scambio completato. Gli spot per cui hai giÃ  inviato una richiesta non sono visibili.
      </div>

      <div class="section-header">
        <h2>Mercato degli scambi</h2>
        <p class="text-muted">Trova spot e proponi uno scambio offrendo i tuoi</p>
      </div>

      <div class="filters">
        <div class="form-row">
          <div class="form-group" style="margin:0">
            <label class="form-label">Cerca</label>
            <input type="text" class="form-input" id="filter-search" placeholder="es. hotel, fabbrica...">
          </div>
          
          <div class="form-group" style="margin:0">
            <label class="form-label">Categoria</label>
            <select class="form-select" id="filter-category">
              <option value="all">Tutte</option>
              <option value="industriale">Industriale</option>
              <option value="hotel">Hotel</option>
              <option value="villa">Villa</option>
              <option value="sanitario">Sanitario</option>
              <option value="militare">Militare</option>
              <option value="altro">Altro</option>
            </select>
          </div>
          
          <div class="form-group" style="margin:0">
            <label class="form-label">Regione</label>
            <select class="form-select" id="filter-region">
              <option value="all">Tutte le regioni</option>
              <option value="Abruzzo">Abruzzo</option>
              <option value="Basilicata">Basilicata</option>
              <option value="Calabria">Calabria</option>
              <option value="Campania">Campania</option>
              <option value="Emilia-Romagna">Emilia-Romagna</option>
              <option value="Friuli-Venezia Giulia">Friuli-Venezia Giulia</option>
              <option value="Lazio">Lazio</option>
              <option value="Liguria">Liguria</option>
              <option value="Lombardia">Lombardia</option>
              <option value="Marche">Marche</option>
              <option value="Molise">Molise</option>
              <option value="Piemonte">Piemonte</option>
              <option value="Puglia">Puglia</option>
              <option value="Sardegna">Sardegna</option>
              <option value="Sicilia">Sicilia</option>
              <option value="Toscana">Toscana</option>
              <option value="Trentino-Alto Adige">Trentino-Alto Adige</option>
              <option value="Umbria">Umbria</option>
              <option value="Valle d'Aosta">Valle d'Aosta</option>
              <option value="Veneto">Veneto</option>
            </select>
          </div>
        </div>

        <div class="flex gap-2 mt-2" style="align-items:center">
          <button class="btn btn-ghost" id="btn-reset-filters">Reset</button>
          <span class="badge badge-primary" id="results-count">0 risultati</span>
        </div>
      </div>

      <div class="grid" id="market-grid"></div>
    </section>

    <!-- REQUESTS VIEW -->
    <section id="view-requests" class="hidden">
      <div class="section-header flex-between">
        <div>
          <h2>Richieste di scambio</h2>
          <p class="text-muted">Gestisci le richieste ricevute e inviate</p>
        </div>
        <button class="btn btn-ghost" onclick="loadTradeRequests()" style="padding: 8px 12px; font-size: 12px;">
          ðŸ”„ Aggiorna
        </button>
      </div>

      <div class="tabs">
        <button class="tab active" data-tab="received">Ricevute <span id="received-count">(0)</span></button>
        <button class="tab" data-tab="sent">Inviate <span id="sent-count">(0)</span></button>
        <button class="tab" data-tab="history">Storico</button>
      </div>

      <div id="tab-received">
        <div id="received-requests"></div>
      </div>

      <div id="tab-sent" class="hidden">
        <div id="sent-requests"></div>
      </div>

      <div id="tab-history" class="hidden">
        <div id="history-requests"></div>
      </div>
    </section>

    <!-- MY SPOTS VIEW -->
    <section id="view-my-spots" class="hidden">
      <div class="section-header flex-between">
        <div>
          <h2>Area Privata</h2>
          <p class="text-muted">Gestisci i tuoi spot pubblicati e ottenuti</p>
        </div>
        <button class="btn btn-primary" onclick="showView('new')">+ Nuovo spot</button>
      </div>

      <div class="tabs">
        <button class="tab active" data-tab="published">Pubblicati <span id="published-count">(0)</span></button>
        <button class="tab" data-tab="acquired">Ottenuti <span id="acquired-count">(0)</span></button>
        <button class="tab" data-tab="profile">Profilo</button>
        <button class="tab" data-tab="map">Mappa</button>
      </div>

      <div id="tab-published">
        <div class="grid" id="published-spots-grid"></div>
      </div>

      <div id="tab-acquired" class="hidden">
        <div class="grid" id="acquired-spots-grid"></div>
      </div>

      <div id="tab-profile" class="hidden">
        <div class="profile-stats">
          <div class="stat-card">
            <div class="stat-value" id="total-spots">0</div>
            <div class="stat-label">Spot totali</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="acquired-spots">0</div>
            <div class="stat-label">Spot ottenuti</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="completed-trades">0</div>
            <div class="stat-label">Scambi completati</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="success-rate">0%</div>
            <div class="stat-label">Successo scambi</div>
          </div>
        </div>

        <div class="settings-grid">
          <div class="setting-item">
            <div class="setting-header">
              <div class="setting-title">Profilo privato</div>
              <div class="setting-switch">
                <label class="switch">
                  <input type="checkbox" id="private-profile-toggle" checked>
                  <span class="slider"></span>
                </label>
              </div>
            </div>
            <div class="setting-description">
              Nascondi le tue statistiche agli altri utenti
            </div>
          </div>

          <div class="setting-item">
            <div class="setting-header">
              <div class="setting-title">Nome utente</div>
            </div>
            <div class="setting-description">
              Il tuo nome pubblico sulla piattaforma
            </div>
            <div class="setting-control">
              <input type="text" class="form-input" id="profile-username">
            </div>
          </div>

          <div class="setting-item">
            <div class="setting-header">
              <div class="setting-title">Bio</div>
            </div>
            <div class="setting-description">
              Breve descrizione del tuo profilo
            </div>
            <div class="setting-control">
              <textarea class="form-textarea" id="profile-bio" rows="3" maxlength="200"></textarea>
            </div>
          </div>
        </div>

        <div class="flex gap-2 mt-2">
          <button class="btn btn-primary" onclick="saveProfileSettings()" style="flex:1">Salva modifiche</button>
          <button class="btn btn-danger" onclick="logout()">Logout</button>
          <button class="btn btn-warning" onclick="returnToAdmin()" style="display: none;" id="return-to-admin-btn">
            Torna a Admin
          </button>
        </div>
      </div>

      <div id="tab-map" class="hidden">
        <div class="map-container">
          <div id="map"></div>
        </div>
        <div class="map-controls-container">
          <button class="btn btn-ghost" onclick="toggleMarkers('published')">ðŸ“ Pubblicati</button>
          <button class="btn btn-ghost" onclick="toggleMarkers('acquired')">ðŸ† Ottenuti</button>
          <button class="btn btn-primary" onclick="toggleMarkers('all')">ðŸŒ Tutti</button>
        </div>
      </div>
    </section>

    <!-- NEW SPOT VIEW -->
    <section id="view-new" class="hidden">
      <div class="section-header">
        <h2>Pubblica nuovo spot</h2>
        <p class="text-muted">Crea un annuncio per scambiare il tuo spot</p>
      </div>

      <div class="card">
        <div class="form-group">
          <label class="form-label">Cosa offri</label>
          <input type="text" class="form-input" id="input-give" maxlength="100" placeholder="es. Ex fabbrica tessile">
          <div class="form-hint">Descrizione breve dello spot che offri in scambio</div>
        </div>

        <div class="form-group">
          <label class="form-label">Cosa cerchi</label>
          <input type="text" class="form-input" id="input-want" maxlength="100" placeholder="es. Hotel o villa abbandonata">
          <div class="form-hint">Cosa vorresti ricevere in cambio</div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Regione</label>
            <select class="form-select" id="input-region">
              <option value="">Seleziona regione...</option>
              <option value="Abruzzo">Abruzzo</option>
              <option value="Basilicata">Basilicata</option>
              <option value="Calabria">Calabria</option>
              <option value="Campania">Campania</option>
              <option value="Emilia-Romagna">Emilia-Romagna</option>
              <option value="Friuli-Venezia Giulia">Friuli-Venezia Giulia</option>
              <option value="Lazio">Lazio</option>
              <option value="Liguria">Liguria</option>
              <option value="Lombardia">Lombardia</option>
              <option value="Marche">Marche</option>
              <option value="Molise">Molise</option>
              <option value="Piemonte">Piemonte</option>
              <option value="Puglia">Puglia</option>
              <option value="Sardegna">Sardegna</option>
              <option value="Sicilia">Sicilia</option>
              <option value="Toscana">Toscana</option>
              <option value="Trentino-Alto Adige">Trentino-Alto Adige</option>
              <option value="Umbria">Umbria</option>
              <option value="Valle d'Aosta">Valle d'Aosta</option>
              <option value="Veneto">Veneto</option>
            </select>
            <div class="form-hint">Seleziona la regione dello spot</div>
          </div>

          <div class="form-group">
            <label class="form-label">Categoria</label>
            <select class="form-select" id="input-category">
              <option value="industriale">Industriale</option>
              <option value="hotel">Hotel</option>
              <option value="villa">Villa</option>
              <option value="sanitario">Sanitario</option>
              <option value="militare">Militare</option>
              <option value="altro">Altro</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Coordinate GPS o Link Google Maps</label>
          <input type="text" class="form-input" id="input-coordinates" placeholder="es. 45.4642, 9.1900 o link Google Maps">
          <div class="form-hint">âš ï¸ Saranno visibili SOLO dopo l'accettazione dello scambio. Puoi inserire coordinate o un link Google Maps.</div>
        </div>

        <div class="form-group">
          <label class="form-label">Descrizione</label>
          <textarea class="form-textarea" id="input-description" maxlength="500" placeholder="Descrivi cosa rende speciale questo spot..."></textarea>
          <div class="form-hint">Info generali sullo spot</div>
        </div>

        <label class="checkbox-label">
          <input type="checkbox" id="input-private">
          <span>
            <strong>Spot Privato</strong> â€” Questo spot sarÃ  visibile solo a te e non apparirÃ  nel mercato
          </span>
        </label>
        
        <label class="checkbox-label">
          <input type="checkbox" id="input-legal">
          <span>
            <strong>Confermo</strong> di avere accordi personali per questo spot e di poterlo scambiare.
          </span>
        </label>
        
        <div class="flex gap-2 mt-2">
          <button class="btn btn-ghost" onclick="showView('my-spots')">Annulla</button>
          <button class="btn btn-primary btn-lg" id="btn-publish">Pubblica spot</button>
        </div>
      </div>
    </section>
  </main>

  <!-- MODAL: SELECT SPOTS TO OFFER -->
  <div class="modal-overlay" id="modal-offer">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Scegli spot da offrire (max 3)</h3>
        <button class="modal-close" onclick="closeModal('modal-offer')">&times;</button>
      </div>

      <div class="alert alert-info">
        Seleziona fino a 3 tuoi spot da offrire in cambio. Il proprietario sceglierÃ  quale accettare.
      </div>

      <div id="offer-spots-list"></div>

      <div class="flex gap-2 mt-2">
        <button class="btn btn-ghost" onclick="closeModal('modal-offer')">Annulla</button>
        <button class="btn btn-primary btn-lg" id="btn-send-offer">Invia proposta</button>
      </div>
    </div>
  </div>

  <!-- MODAL: CHOOSE SPOT FROM OFFER -->
  <div class="modal-overlay" id="modal-choose">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Scegli spot da ricevere</h3>
        <button class="modal-close" onclick="closeModal('modal-choose')">&times;</button>
      </div>

      <div class="alert alert-info">
        Scegli quale spot accettare in cambio del tuo. Puoi selezionarne solo uno.
      </div>

      <div id="choose-spots-list"></div>

      <div class="flex gap-2 mt-2">
        <button class="btn btn-ghost" onclick="closeModal('modal-choose')">Annulla</button>
        <button class="btn btn-success btn-lg" id="btn-accept-trade">Accetta scambio</button>
      </div>
    </div>
  </div>

  <!-- MODAL: SPOT DETAIL -->
  <div class="modal-overlay" id="modal-detail">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="detail-title"></h3>
        <button class="modal-close" onclick="closeModal('modal-detail')">&times;</button>
      </div>

      <div id="detail-content"></div>

      <div id="detail-actions" class="mt-2"></div>
    </div>
  </div>

  <!-- MODAL: ADMIN TRADE DETAIL -->
  <div class="modal-overlay" id="modal-admin-trade">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Dettagli Scambio</h3>
        <button class="modal-close" onclick="closeModal('modal-admin-trade')">&times;</button>
      </div>

      <div id="admin-trade-detail"></div>

      <div id="admin-trade-actions" class="mt-2"></div>
    </div>
  </div>

  <!-- MODAL: EDIT USER (ADMIN) -->
<div class="modal-overlay" id="modal-edit-spot">
  <div class="modal">
    <div class="modal-header">
      <h3 class="modal-title">Modifica Spot</h3>
      <button class="modal-close" onclick="closeModal('modal-edit-spot')">&times;</button>
    </div>

    <div id="edit-spot-content"></div>
  </div>
</div>

  <!-- TOAST -->
  <div class="toast" id="toast"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
   integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
   crossorigin=""></script>

  <script>
    
    // ========== ANTI-SPAM CONTROL ==========
    let isChangingView = false;
    let lastClickTime = 0;
    const CLICK_DELAY = 300; // 300ms delay between clicks
    // ========== CONSTANTS ==========
    const API_BASE = '/api';

    // ========== STATE ==========
    let state = {
      user: null,
      isAdmin: false,
      spots: [],
      tradeRequests: [],
      currentOfferId: null,
      currentRequestId: null,
      selectedOfferSpots: [],
      adminSpots: [],
      adminTrades: [],
      adminUsers: []
    };

    // ========== MAP VARIABLES ==========
    let map = null;
    let markers = [];
    let currentMapFilter = 'all';

    // ========== LOADING OVERLAY ==========
    let loadingCount = 0;
    
    function showLoading(text = 'Caricamento...') {
      loadingCount++;
      const overlay = document.getElementById('loading-overlay');
      const loadingText = overlay.querySelector('.loading-text');
      
      loadingText.textContent = text;
      
      // Mostra solo se Ã¨ il primo carico
      if (loadingCount === 1) {
        overlay.classList.add('show');
      }
    }
    
    function hideLoading() {
      loadingCount = Math.max(0, loadingCount - 1);
      
      // Nascondi solo quando tutti i carichi sono completati
      if (loadingCount === 0) {
        setTimeout(() => {
          if (loadingCount === 0) {
            document.getElementById('loading-overlay').classList.remove('show');
          }
        }, 300); // Piccolo delay per evitare flickering
      }
    }

    // ========== UTILITY FUNCTIONS ==========
    
    function cleanCoordinates(coords) {
      if (!coords) return coords;
      
      let cleaned = coords.trim()
        .replace(/^\(+/, '')
        .replace(/\)+$/, '')
        .replace(/\s+/g, ' ')
        .trim();
      
      return cleaned;
    }
    
    async function extractCoordinatesFromLink(link) {
      if (!link) return null;
      
      if (link.includes(',') && !link.includes('http')) {
        return cleanCoordinates(link);
      }
      
      if (link.includes('goo.gl') || link.includes('maps.app.goo.gl')) {
        try {
          const response = await fetch(`/api/resolve-map-link?url=${encodeURIComponent(link)}`);
          if (response.ok) {
            const data = await response.json();
            if (data.coordinates) {
              return cleanCoordinates(data.coordinates);
            }
          }
        } catch (error) {
          console.error('Error resolving Google Maps link:', error);
        }
      }
      
      if (link.includes('google.com/maps')) {
        const atMatch = link.match(/@(-?\d+\.\d+),(-?\d+\.\d+)/);
        if (atMatch) {
          return `${atMatch[1]}, ${atMatch[2]}`;
        }
        
        const qMatch = link.match(/[?&]q=(-?\d+\.\d+),(-?\d+\.\d+)/);
        if (qMatch) {
          return `${qMatch[1]}, ${qMatch[2]}`;
        }
        
        const llMatch = link.match(/[?&]ll=(-?\d+\.\d+),(-?\d+\.\d+)/);
        if (llMatch) {
          return `${llMatch[1]}, ${llMatch[2]}`;
        }
      }
      
      return cleanCoordinates(link);
    }

    // ========== INIT ==========
    async function init() {
      await checkSession();
      if (!state.user) {
        showLogin();
      } else if (state.isAdmin) {
        showAdminPanel();
        loadAdminData();
      } else {
        setupEventListeners();
        await loadInitialData();
        showView('market');
        updateUI();
        startVerificationChecker();
      }
      if (state.user && state.user.isTemporaryLogin) {
        document.getElementById('return-to-admin-btn').style.display = 'block';
      }
    }

    // ========== AUTH FUNCTIONS ==========
    async function checkSession() {
      try {
        const response = await fetch(`${API_BASE}/session`);
        const data = await response.json();
        
        if (data.loggedIn) {
          state.user = data.user;
          state.isAdmin = data.isAdmin;
          return true;
        }
        return false;
      } catch (error) {
        console.error('Session check error:', error);
        return false;
      }
    }

    async function handleLogin() {
      const username = document.getElementById('login-username').value;
      const password = document.getElementById('login-password').value;
      const errorDiv = document.getElementById('login-error');
      
      if (!username || !password) {
        errorDiv.textContent = 'Inserisci username e password';
        errorDiv.style.display = 'block';
        return;
      }
      
      showLoading('Accesso in corso...');
      
      try {
        const response = await fetch(`${API_BASE}/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });
        
        const data = await response.json();
        
        if (data.success) {
          state.user = data.user;
          state.isAdmin = data.isAdmin;
          
          if (state.isAdmin) {
            showAdminPanel();
            loadAdminData();
          } else {
            hideLogin();
            setupEventListeners();
            await loadInitialData();
            showView('market');
            updateUI();
            startVerificationChecker();
          }
        } else {
          errorDiv.textContent = data.error || 'Credenziali non valide';
          errorDiv.style.display = 'block';
        }
      } catch (error) {
        console.error('Login error:', error);
        errorDiv.textContent = 'Errore di connessione';
        errorDiv.style.display = 'block';
      } finally {
        hideLoading();
      }
    }

    async function logout() {
      document.getElementById('beta-banner').style.display = 'none';
      showLoading('Logout...');
      try {
        await fetch(`${API_BASE}/logout`, { method: 'POST' });
        location.reload();
      } catch (error) {
        console.error('Logout error:', error);
        location.reload();
      }
    }
    async function returnToAdmin() {
      if (!confirm('Tornare all\'account admin?')) return;
      
      showLoading('Ritorno a admin...');
      try {
        const response = await fetch(`${API_BASE}/admin/return-to-admin`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        if (response.ok) {
          const data = await response.json();
          state.user = data.user;
          state.isAdmin = data.isAdmin;
          
          // Nascondi l'app principale e mostra il pannello admin
          document.querySelector('header').style.display = 'none';
          document.querySelector('.container').style.display = 'none';
          document.getElementById('admin-panel').style.display = 'block';
          
          // Ricarica i dati admin
          loadAdminData();
          
          showToast('Ritornato all\'account admin', 'success');
        } else {
          showToast('Errore nel ritorno a admin', 'error');
        }
      } catch (error) {
        console.error('Error returning to admin:', error);
        showToast('Errore di connessione', 'error');
      } finally {
        hideLoading();
      }
    }
    function showLogin() {
      document.getElementById('login-screen').style.display = 'flex';
      document.getElementById('code-input-screen').style.display = 'none';
      document.querySelector('header').style.display = 'none';
      document.querySelector('.container').style.display = 'none';
      document.getElementById('admin-panel').style.display = 'none';
    }

    function hideLogin() {
      document.getElementById('login-screen').style.display = 'none';
      document.getElementById('code-input-screen').style.display = 'none';
      document.querySelector('header').style.display = 'block';
      document.querySelector('.container').style.display = 'block';
      document.getElementById('admin-panel').style.display = 'none';
    }

    // ========== CODE REGISTRATION FUNCTIONS ==========
    function showCodeInput() {
      document.getElementById('beta-banner').style.display = 'block';
      document.getElementById('login-screen').style.display = 'none';
      document.getElementById('code-input-screen').style.display = 'flex';
      
      // Reset dei campi
      document.getElementById('code-input').value = '';
      document.getElementById('code-username').value = '';
      document.getElementById('code-password').value = '';
      document.getElementById('code-confirm-password').value = '';
      document.getElementById('code-error').style.display = 'none';
      document.getElementById('code-success').style.display = 'none';
      
      // Formattazione automatica del codice
      const codeInput = document.getElementById('code-input');
      codeInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/-/g, '');
        if (value.length > 12) value = value.substring(0, 12);
        
        if (value.length > 8) {
          value = value.substring(0, 4) + '-' + value.substring(4, 8) + '-' + value.substring(8, 12);
        } else if (value.length > 4) {
          value = value.substring(0, 4) + '-' + value.substring(4, 8);
        }
        e.target.value = value.toUpperCase();
      });
      
      // Focus sul campo codice
      setTimeout(() => {
        codeInput.focus();
      }, 100);
    }

    function showLoginFromCode() {
      document.getElementById('code-input-screen').style.display = 'none';
      document.getElementById('login-screen').style.display = 'flex';
    }

    async function handleCodeRegistration() {
      const code = document.getElementById('code-input').value.replace(/-/g, '');
      const username = document.getElementById('code-username').value.trim();
      const password = document.getElementById('code-password').value;
      const confirmPassword = document.getElementById('code-confirm-password').value;
      const errorDiv = document.getElementById('code-error');
      const successDiv = document.getElementById('code-success');
      
      errorDiv.style.display = 'none';
      successDiv.style.display = 'none';
      
      if (!code || code.length !== 12) {
        errorDiv.textContent = 'Codice non valido. Deve essere di 12 caratteri';
        errorDiv.style.display = 'block';
        return;
      }
      
      if (!username || !password || !confirmPassword) {
        errorDiv.textContent = 'Compila tutti i campi';
        errorDiv.style.display = 'block';
        return;
      }
      
      if (password !== confirmPassword) {
        errorDiv.textContent = 'Le password non corrispondono';
        errorDiv.style.display = 'block';
        return;
      }
      
      if (password.length < 6) {
        errorDiv.textContent = 'La password deve essere di almeno 6 caratteri';
        errorDiv.style.display = 'block';
        return;
      }
      
      showLoading('Registrazione in corso...');
      
      try {
        const response = await fetch('/api/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token: code, username, password })
        });
        
        const data = await response.json();
        
        if (data.success) {
          successDiv.textContent = 'âœ… Registrazione completata! Ora puoi accedere con le tue credenziali.';
          successDiv.style.display = 'block';
          
          document.getElementById('code-input').value = '';
          document.getElementById('code-username').value = '';
          document.getElementById('code-password').value = '';
          document.getElementById('code-confirm-password').value = '';
          
          setTimeout(() => {
            showLoginFromCode();
          }, 3000);
        } else {
          errorDiv.textContent = data.error || 'Errore nella registrazione';
          errorDiv.style.display = 'block';
        }
      } catch (error) {
        console.error('Registration error:', error);
        errorDiv.textContent = 'Errore di connessione';
        errorDiv.style.display = 'block';
      } finally {
        hideLoading();
      }
    }

    // ========== ADMIN FUNCTIONS ==========
    function showAdminPanel() {
      document.getElementById('login-screen').style.display = 'none';
      document.getElementById('code-input-screen').style.display = 'none';
      document.querySelector('header').style.display = 'none';
      document.querySelector('.container').style.display = 'none';
      document.getElementById('admin-panel').style.display = 'block';
      
      document.querySelectorAll('[data-admin-tab]').forEach(tab => {
        tab.addEventListener('click', () => {
          const tabName = tab.dataset.adminTab;
          document.querySelectorAll('[data-admin-tab]').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          
          document.getElementById('admin-tab-trades').classList.toggle('hidden', tabName !== 'trades');
          document.getElementById('admin-tab-spots').classList.toggle('hidden', tabName !== 'spots');
          document.getElementById('admin-tab-users').classList.toggle('hidden', tabName !== 'users');
          document.getElementById('admin-tab-invites').classList.toggle('hidden', tabName !== 'invites');
          
          if (tabName === 'spots') {
            loadAdminSpots();
          } else if (tabName === 'trades') {
            loadAdminTrades();
          } else if (tabName === 'users') {
            loadAdminUsers();
          }
        });
      });

      // Setup file upload
      setupFileUpload();
    }

    async function loadAdminData() {
      showLoading('Caricamento dati admin...');
      
      try {
        const [stats, users, trades, invites] = await Promise.all([
          fetch(`${API_BASE}/admin/stats`).then(r => r.json()),
          fetch(`${API_BASE}/admin/users`).then(r => r.json()),
          fetch(`${API_BASE}/admin/trades`).then(r => r.json()),
          fetch(`${API_BASE}/admin/invites`).then(r => r.json())
        ]);
        
        state.adminUsers = users;
        
        document.getElementById('admin-stats').innerHTML = `
          <div class="admin-stat-card">
            <div class="admin-small-stat" style="color: var(--primary);">${stats.totalUsers || 0}</div>
            <div style="color: var(--text-muted); font-size: 12px;">Utenti Totali</div>
          </div>
          <div class="admin-stat-card">
            <div class="admin-small-stat" style="color: var(--success);">${stats.totalSpots || 0}</div>
            <div style="color: var(--text-muted); font-size: 12px;">Spot Totali</div>
          </div>
          <div class="admin-stat-card">
            <div class="admin-small-stat" style="color: var(--warning);">${stats.activeSpots || 0}</div>
            <div style="color: var(--text-muted); font-size: 12px;">Spot Attivi</div>
          </div>
          <div class="admin-stat-card">
            <div class="admin-small-stat" style="color: var(--info);">${stats.totalTrades || 0}</div>
            <div style="color: var(--text-muted); font-size: 12px;">Scambi Totali</div>
          </div>
          <div class="admin-stat-card">
            <div class="admin-small-stat" style="color: var(--primary-light);">${stats.fanUsers || 0}</div>
            <div style="color: var(--text-muted); font-size: 12px;">Fan Registrati</div>
          </div>
          <div class="admin-stat-card">
            <div class="admin-small-stat" style="color: var(--warning);">${stats.activeInvites || 0}</div>
            <div style="color: var(--text-muted); font-size: 12px;">Codici Attivi</div>
          </div>
          <div class="admin-stat-card">
            <div class="admin-small-stat" style="color: var(--danger);">${stats.pendingAdminApprovalTrades || 0}</div>
            <div style="color: var(--text-muted); font-size: 12px;">Scambi da Approvare</div>
          </div>
        `;
        
        state.adminTrades = trades;
        
        renderAdminTradesList();
        
        document.getElementById('users-list').innerHTML = users.map(user => `
          <div class="user-list-item">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div style="flex: 1;">
                <strong>${user.username}</strong>
                <div style="color: var(--text-muted); font-size: 11px; margin-top: 2px;">
                  ${user.role} â€¢ ${new Date(user.createdAt).toLocaleDateString('it-IT')}
                  ${user.isFan ? ' â€¢ Fan Account' : ''}
                </div>
              </div>
              <div style="display: flex; gap: 6px;">
                <button class="btn btn-ghost" onclick="editUser('${user._id}')" style="padding: 5px 10px; font-size: 11px;">
                  âœï¸ Modifica
                </button>
                <button class="btn btn-primary" onclick="loginAsUser('${user.username}')" style="padding: 5px 10px; font-size: 11px;">
                  ðŸ”‘ Accedi come
                </button>
                ${user.role !== 'admin' ? `
                  <button class="btn btn-danger" onclick="deleteUser('${user._id}')" style="padding: 5px 10px; font-size: 11px;">
                    ðŸ—‘ï¸ Elimina
                  </button>
                ` : ''}
              </div>
            </div>
          </div>
        `).join('');
        
        const activeInvites = invites.filter(invite => !invite.used);
        
        document.getElementById('active-invites').innerHTML = activeInvites.map(invite => {
          const formattedCode = invite.token.replace(/(.{4})(.{4})(.{4})/, '$1-$2-$3');
          
          return `
            <div class="invite-list-item">
              <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <div>
                  <strong>Codice: ${formattedCode}</strong>
                  <div style="color: var(--text-muted); font-size: 11px; margin-top: 2px;">
                    Creato da: ${invite.createdBy} â€¢ ${new Date(invite.createdAt).toLocaleDateString('it-IT')}
                  </div>
                </div>
                <span class="invite-status ${invite.used ? 'used' : 'active'}">
                  ${invite.used ? 'Usato' : 'Attivo'}
                </span>
              </div>
              ${invite.usedBy ? `
                <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 8px;">
                  Usato da: ${invite.usedBy} il ${new Date(invite.usedAt).toLocaleDateString('it-IT')}
                </div>
              ` : ''}
              ${!invite.used ? `
                <div class="url-box" onclick="copyToClipboard('${formattedCode}')">
                  ${formattedCode}
                </div>
                <button class="btn btn-danger mt-2" onclick="deleteInvite('${invite._id}')" style="width: 100%; padding: 5px; font-size: 11px;">
                  Elimina Codice
                </button>
              ` : ''}
            </div>
          `;
        }).join('');
        
      } catch (error) {
        console.error('Error loading admin data:', error);
        document.getElementById('admin-stats').innerHTML = '<div class="text-muted">Errore nel caricamento dei dati</div>';
      } finally {
        hideLoading();
      }
    }

    async function loadAdminTrades() {
      showLoading('Caricamento scambi...');
      try {
        const response = await fetch(`${API_BASE}/admin/trades`);
        if (response.ok) {
          state.adminTrades = await response.json();
          renderAdminTradesList();
        }
      } catch (error) {
        console.error('Error loading admin trades:', error);
        showToast('Errore nel caricamento degli scambi', 'error');
      } finally {
        hideLoading();
      }
    }

    async function loadAdminSpots() {
      showLoading('Caricamento spot...');
      try {
        const response = await fetch(`${API_BASE}/admin/spots`);
        if (response.ok) {
          state.adminSpots = await response.json();
          renderAdminSpotsList();
        }
      } catch (error) {
        console.error('Error loading admin spots:', error);
        showToast('Errore nel caricamento degli spot', 'error');
      } finally {
        hideLoading();
      }
    }

    async function loadAdminUsers() {
      showLoading('Caricamento utenti...');
      try {
        const response = await fetch(`${API_BASE}/admin/users`);
        if (response.ok) {
          state.adminUsers = await response.json();
          await loadAdminData(); // Refresh the whole panel
        }
      } catch (error) {
        console.error('Error loading admin users:', error);
        showToast('Errore nel caricamento utenti', 'error');
      } finally {
        hideLoading();
      }
    }

    function renderAdminTradesList() {
      const pendingTrades = state.adminTrades.filter(t => 
        !t.adminApproved && !t.adminRejected && t.status === 'pending'
      );
      
      const container = document.getElementById('admin-trades-list');
      
      if (pendingTrades.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">âœ…</div>
            <div>Nessuno scambio in attesa di approvazione</div>
          </div>
        `;
        return;
      }
      
      container.innerHTML = pendingTrades.map(trade => {
        const spot = trade.spotId || {};
        const offeredSpots = trade.offeredSpots || [];
        
        return `
          <div class="trade-request">
            <div class="flex-between mb-2">
              <div>
                <strong>${escapeHtml(trade.fromUser)} â†’ ${escapeHtml(trade.toUser)}</strong>
                <div class="text-muted" style="font-size:12px;margin-top:2px">
                  ${new Date(trade.createdAt).toLocaleString('it-IT')}
                </div>
              </div>
              <span class="trade-status pending">â³ In attesa</span>
            </div>
            
            <div class="trade-details-box">
              <div style="margin-bottom: 10px;">
                <strong>Spot richiesto:</strong>
                <div class="trade-spot-info">
                  <strong>${escapeHtml(spot.give || 'N/A')}</strong>
                  <div style="font-size: 12px; color: var(--text-muted);">
                    ðŸ“ ${escapeHtml(spot.region || '')} â€¢ ${spot.category || ''}
                  </div>
                  <div style="font-size: 11px; margin-top: 4px;">
                    ${escapeHtml(spot.description || '').substring(0, 100)}${spot.description && spot.description.length > 100 ? '...' : ''}
                  </div>
                </div>
              </div>
              
              <div>
                <strong>Spot offerti in cambio:</strong>
                ${offeredSpots.map(s => `
                  <div class="trade-spot-info">
                    <strong>${escapeHtml(s.give || 'N/A')}</strong>
                    <div style="font-size: 12px; color: var(--text-muted);">
                      ðŸ“ ${escapeHtml(s.region || '')} â€¢ ${s.category || ''}
                    </div>
                    <div style="font-size: 11px; margin-top: 4px;">
                      ${escapeHtml((s.description || '').substring(0, 80))}${s.description && s.description.length > 80 ? '...' : ''}
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
            
            <div class="admin-action-buttons">
              <button class="btn btn-success" onclick="approveTrade('${trade._id}')">
                âœ… Approva Scambio
              </button>
              <button class="btn btn-danger" onclick="rejectTrade('${trade._id}')">
                âŒ Rifiuta Scambio
              </button>
              <button class="btn btn-ghost" onclick="viewAdminTradeDetail('${trade._id}')">
                ðŸ“‹ Dettagli
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderAdminSpotsList() {
  const container = document.getElementById('admin-spots-list');
  
  const originalSpots = state.adminSpots.filter(spot => 
    !spot.originalSpotId && !spot.acquired
  );
  
  if (originalSpots.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">ðŸ“</div>
        <div>Nessuno spot trovato</div>
      </div>
    `;
    return;
  }
  
  container.innerHTML = originalSpots.map(spot => {
    let statusBadge = '';
    switch(spot.status) {
      case 'active':
        statusBadge = '<span class="badge badge-success">Attivo</span>';
        break;
      case 'in_trade':
        statusBadge = '<span class="badge badge-warning">In Scambio</span>';
        break;
      case 'completed':
        statusBadge = '<span class="badge badge-info">Completato</span>';
        break;
      case 'deleted':
        statusBadge = '<span class="badge badge-danger">Eliminato</span>';
        break;
    }
    
    return `
      <div class="spot-list-item">
        <div class="spot-list-header">
          <div style="flex: 1;">
            <strong>${escapeHtml(spot.give)}</strong>
            <div style="font-size: 12px; color: var(--text-muted); margin-top: 2px;">
              ðŸ“ ${escapeHtml(spot.region)} â€¢ ${spot.category} â€¢ di ${escapeHtml(spot.author)}
            </div>
            ${spot.isAdminCreated ? '<div style="font-size: 11px; color: var(--warning); margin-top: 2px;">Creato da Admin</div>' : ''}
          </div>
          <div>
            ${statusBadge}
          </div>
        </div>
        
        <div style="font-size: 12px; margin: 8px 0;">
          <strong>Offre:</strong> ${escapeHtml(spot.give)}<br>
          <strong>Cerca:</strong> ${escapeHtml(spot.want)}
        </div>
        
        <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 8px;">
          Creato: ${new Date(spot.createdAt).toLocaleDateString('it-IT')}
          ${spot.hasPendingTradeRequest ? '<br><span style="color: var(--warning);">âš ï¸ Ha richieste pendenti</span>' : ''}
        </div>
        
        <div class="spot-list-actions">
          <button class="btn btn-ghost" onclick="viewAdminSpotDetail('${spot._id}')">
            ðŸ‘ï¸ Dettagli
          </button>
          <!-- AGGIUNGI QUESTO PULSANTE MODIFICA -->
          <button class="btn btn-warning" onclick="editAdminSpot('${spot._id}')">
            âœï¸ Modifica
          </button>
          ${spot.status !== 'deleted' ? `
            <button class="btn btn-danger" onclick="deleteAdminSpot('${spot._id}')">
              ðŸ—‘ï¸ Elimina
            </button>
          ` : ''}
          ${spot.coordinates ? `
            <button class="btn btn-primary" onclick="openInGoogleMaps('${escapeHtml(spot.coordinates)}', '${escapeHtml(spot.give)}')">
              ðŸ—ºï¸ Mappa
            </button>
          ` : ''}
        </div>
      </div>
    `;
  }).join('');
}

    async function searchAdminSpots() {
      const search = document.getElementById('admin-spot-search').value;
      showLoading('Ricerca...');
      try {
        const response = await fetch(`${API_BASE}/admin/spots${search ? `?search=${encodeURIComponent(search)}` : ''}`);
        if (response.ok) {
          state.adminSpots = await response.json();
          renderAdminSpotsList();
        }
      } catch (error) {
        console.error('Error searching admin spots:', error);
      } finally {
        hideLoading();
      }
    }

    async function viewAdminSpotDetail(spotId) {
      const spot = state.adminSpots.find(s => s._id === spotId);
      if (!spot) return;
      
      const content = `
        <div style="margin-bottom: 15px;">
          <h4 style="margin-bottom: 10px;">${escapeHtml(spot.give)}</h4>
          <div class="tags mb-2">
            <span class="badge badge-info">${spot.category}</span>
            <span class="badge ${spot.status === 'active' ? 'badge-success' : spot.status === 'in_trade' ? 'badge-warning' : spot.status === 'completed' ? 'badge-info' : 'badge-danger'}">
              ${spot.status === 'active' ? 'Attivo' : spot.status === 'in_trade' ? 'In scambio' : spot.status === 'completed' ? 'Completato' : 'Eliminato'}
            </span>
            ${spot.acquired ? '<span class="badge badge-warning">Ottenuto</span>' : ''}
          </div>
        </div>
        
        <div class="mb-3">
          <strong>Autore:</strong> ${escapeHtml(spot.author)}<br>
          <strong>Zona:</strong> ${escapeHtml(spot.region)}<br>
          <strong>Creato:</strong> ${new Date(spot.createdAt).toLocaleString('it-IT')}<br>
          ${spot.acquiredDate ? `<strong>Ottenuto il:</strong> ${new Date(spot.acquiredDate).toLocaleDateString('it-IT')}<br>` : ''}
          ${spot.currentOwner ? `<strong>Proprietario attuale:</strong> ${escapeHtml(spot.currentOwner)}<br>` : ''}
          ${spot.originalAuthor ? `<strong>Autore originale:</strong> ${escapeHtml(spot.originalAuthor)}<br>` : ''}
        </div>
        
        <div class="mb-3">
          <strong>Offre:</strong> ${escapeHtml(spot.give)}<br>
          <strong>Cerca:</strong> ${escapeHtml(spot.want)}
        </div>
        
        <div class="mb-3">
          <strong>Descrizione:</strong><br>
          <div style="background: var(--bg-light); padding: 10px; border-radius: 6px; margin-top: 5px;">
            ${escapeHtml(spot.description || 'Nessuna descrizione')}
          </div>
        </div>
        
        ${spot.coordinates ? `
          <div class="mb-3">
            <strong>Coordinate GPS:</strong><br>
            <div style="background: var(--bg-light); padding: 10px; border-radius: 6px; margin-top: 5px; font-family: monospace;">
              ${escapeHtml(spot.coordinates)}
            </div>
            <button class="btn btn-primary mt-2" onclick="openInGoogleMaps('${escapeHtml(spot.coordinates)}', '${escapeHtml(spot.give)}')">
              ðŸ—ºï¸ Apri in Google Maps
            </button>
          </div>
        ` : ''}
        
        <div class="mb-3">
          <strong>Dettagli tecnici:</strong><br>
          <div style="font-size: 12px; color: var(--text-muted);">
            ID: ${spot._id}<br>
            ${spot.isAdminCreated ? 'Creato da Admin<br>' : ''}
            ${spot.hasPendingTradeRequest ? 'Ha richieste di scambio pendenti<br>' : ''}
            ${spot.requestedBy && spot.requestedBy.length > 0 ? `Richiesto da: ${spot.requestedBy.join(', ')}<br>` : ''}
          </div>
        </div>
      `;
      
      document.getElementById('admin-trade-detail').innerHTML = content;
      document.getElementById('admin-trade-actions').innerHTML = `
        <div class="flex gap-2">
          <button class="btn btn-ghost" onclick="closeModal('modal-admin-trade')">Chiudi</button>
          ${spot.status !== 'deleted' ? `
            <button class="btn btn-danger" onclick="deleteAdminSpot('${spot._id}')">Elimina Spot</button>
          ` : ''}
        </div>
      `;
      
      document.getElementById('modal-admin-trade').querySelector('.modal-title').textContent = `Dettagli Spot: ${escapeHtml(spot.give)}`;
      openModal('modal-admin-trade');
    }

    async function viewAdminTradeDetail(tradeId) {
      const trade = state.adminTrades.find(t => t._id === tradeId);
      if (!trade) return;
      
      const spot = trade.spotId || {};
      const offeredSpots = trade.offeredSpots || [];
      
      const content = `
        <div style="margin-bottom: 15px;">
          <h4 style="margin-bottom: 10px;">Scambio tra ${escapeHtml(trade.fromUser)} e ${escapeHtml(trade.toUser)}</h4>
          <div class="tags mb-2">
            <span class="trade-status ${trade.status}">
              ${trade.status === 'pending' ? 'In attesa' : trade.status === 'verifying' ? 'In verifica' : trade.status === 'accepted' ? 'Accettato' : 'Rifiutato'}
            </span>
            ${trade.adminApproved ? '<span class="badge badge-success">Approvato da Admin</span>' : ''}
            ${trade.adminRejected ? '<span class="badge badge-danger">Rifiutato da Admin</span>' : ''}
          </div>
        </div>
        
        <div class="mb-3">
          <strong>Creato:</strong> ${new Date(trade.createdAt).toLocaleString('it-IT')}<br>
          <strong>Aggiornato:</strong> ${new Date(trade.updatedAt).toLocaleString('it-IT')}<br>
          ${trade.verificationStartedAt ? `<strong>Verifica iniziata:</strong> ${new Date(trade.verificationStartedAt).toLocaleString('it-IT')}<br>` : ''}
        </div>
        
        <div class="trade-details-box">
          <div style="margin-bottom: 15px;">
            <strong>Spot richiesto da ${escapeHtml(trade.fromUser)}:</strong>
            <div class="trade-spot-info">
              <strong>${escapeHtml(spot.give || 'N/A')}</strong>
              <div style="font-size: 12px; color: var(--text-muted);">
                ðŸ“ ${escapeHtml(spot.region || '')} â€¢ ${spot.category || ''}
              </div>
              <div style="font-size: 11px; margin-top: 4px;">
                ${escapeHtml(spot.description || '').substring(0, 150)}${spot.description && spot.description.length > 150 ? '...' : ''}
              </div>
              ${spot.coordinates ? `
                <div style="margin-top: 8px;">
                  <strong>Coordinate:</strong>
                  <div style="font-family: monospace; font-size: 12px; background: var(--bg); padding: 6px; border-radius: 4px;">
                    ${escapeHtml(spot.coordinates)}
                  </div>
                </div>
              ` : ''}
            </div>
          </div>
          
          <div style="margin-bottom: 15px;">
            <strong>Spot offerti da ${escapeHtml(trade.fromUser)}:</strong>
            ${offeredSpots.map(s => `
              <div class="trade-spot-info">
                <strong>${escapeHtml(s.give || 'N/A')}</strong>
                <div style="font-size: 12px; color: var(--text-muted);">
                  ðŸ“ ${escapeHtml(s.region || '')} â€¢ ${s.category || ''}
                </div>
                <div style="font-size: 11px; margin-top: 4px;">
                  ${escapeHtml((s.description || '').substring(0, 100))}${s.description && s.description.length > 100 ? '...' : ''}
                </div>
                ${s.coordinates ? `
                  <div style="margin-top: 6px;">
                    <strong>Coordinate:</strong>
                    <div style="font-family: monospace; font-size: 11px; background: var(--bg); padding: 4px; border-radius: 4px;">
                      ${escapeHtml(s.coordinates)}
                    </div>
                  </div>
                ` : ''}
              </div>
            `).join('')}
          </div>
          
          ${trade.selectedSpotId ? `
            <div>
              <strong>Spot selezionato da ${escapeHtml(trade.toUser)}:</strong>
              <div class="trade-spot-info">
                <strong>${escapeHtml(trade.selectedSpotId.give || 'N/A')}</strong>
                <div style="font-size: 12px; color: var(--text-muted);">
                  ðŸ“ ${escapeHtml(trade.selectedSpotId.region || '')} â€¢ ${trade.selectedSpotId.category || ''}
                </div>
                ${trade.selectedSpotId.coordinates ? `
                  <div style="margin-top: 6px;">
                    <strong>Coordinate:</strong>
                    <div style="font-family: monospace; font-size: 11px; background: var(--bg); padding: 4px; border-radius: 4px;">
                      ${escapeHtml(trade.selectedSpotId.coordinates)}
                    </div>
                  </div>
                ` : ''}
              </div>
            </div>
          ` : ''}
        </div>
      `;
      
      let actions = '';
      if (!trade.adminApproved && !trade.adminRejected) {
        actions = `
          <div class="admin-action-buttons">
            <button class="btn btn-success" onclick="approveTrade('${trade._id}')">
              âœ… Approva Scambio
            </button>
            <button class="btn btn-danger" onclick="rejectTrade('${trade._id}')">
              âŒ Rifiuta Scambio
            </button>
          </div>
        `;
      } else {
        actions = '<button class="btn btn-ghost" onclick="closeModal(\'modal-admin-trade\')">Chiudi</button>';
      }
      
      document.getElementById('admin-trade-detail').innerHTML = content;
      document.getElementById('admin-trade-actions').innerHTML = actions;
      
      document.getElementById('modal-admin-trade').querySelector('.modal-title').textContent = `Dettagli Scambio #${trade._id.substring(0, 8)}`;
      openModal('modal-admin-trade');
    }

    async function approveTrade(tradeId) {
      showLoading('Approvazione in corso...');
      try {
        const response = await fetch(`${API_BASE}/admin/trade-requests/${tradeId}/approve`, {
          method: 'PUT'
        });
        
        if (response.ok) {
          showToast('Scambio approvato! Il destinatario puÃ² ora vedere la richiesta.', 'success');
          closeModal('modal-admin-trade');
          loadAdminData();
        } else {
          const data = await response.json();
          showToast(data.error || 'Errore nell\'approvazione', 'error');
        }
      } catch (error) {
        console.error('Error approving trade:', error);
        showToast('Errore nell\'approvazione', 'error');
      } finally {
        hideLoading();
      }
    }

    async function rejectTrade(tradeId) {
      if (!confirm('Sei sicuro di voler rifiutare questo scambio?')) return;
      
      showLoading('Rifiuto in corso...');
      try {
        const response = await fetch(`${API_BASE}/admin/trade-requests/${tradeId}/reject`, {
          method: 'PUT'
        });
        
        if (response.ok) {
          showToast('Scambio rifiutato', 'success');
          closeModal('modal-admin-trade');
          loadAdminData();
        } else {
          const data = await response.json();
          showToast(data.error || 'Errore nel rifiuto', 'error');
        }
      } catch (error) {
        console.error('Error rejecting trade:', error);
        showToast('Errore nel rifiuto', 'error');
      } finally {
        hideLoading();
      }
    }

    async function deleteAdminSpot(spotId) {
      if (!confirm('Sei sicuro di voler eliminare questo spot? Verranno eliminate anche tutte le richieste di scambio associate.')) return;
      
      showLoading('Eliminazione in corso...');
      try {
        const response = await fetch(`${API_BASE}/admin/spots/${spotId}`, {
          method: 'DELETE'
        });
        
        if (response.ok) {
          showToast('Spot eliminato con successo', 'success');
          closeModal('modal-admin-trade');
          loadAdminSpots();
          loadAdminData();
        } else {
          const data = await response.json();
          showToast(data.error || 'Errore nell\'eliminazione', 'error');
        }
      } catch (error) {
        console.error('Error deleting admin spot:', error);
        showToast('Errore nell\'eliminazione', 'error');
      } finally {
        hideLoading();
      }
    }
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('login-button').addEventListener('click', handleLogin);
    });
    async function generateInviteCode() {
      showLoading('Generazione codice...');
      
      try {
        const response = await fetch(`${API_BASE}/admin/invites`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({})
        });
        
        const data = await response.json();
        
        if (data.success) {
          const resultDiv = document.getElementById('invite-result');
          const formattedCode = data.invite.token.replace(/(.{4})(.{4})(.{4})/, '$1-$2-$3');
          
          resultDiv.innerHTML = `
            <div class="alert alert-success">
              <strong>âœ… Codice generato con successo!</strong><br><br>
              <div class="url-box" onclick="copyToClipboard('${formattedCode}')">
                ${formattedCode}
              </div>
              <div style="margin-top: 10px; font-size: 12px;">
                Codice: <code>${formattedCode}</code><br>
                Non scade mai â€¢ Usa una volta
              </div>
            </div>
          `;
          resultDiv.style.display = 'block';
          
          setTimeout(() => loadAdminData(), 1000);
        }
      } catch (error) {
        console.error('Error generating invite:', error);
        showToast('Errore nella generazione del codice', 'error');
      } finally {
        hideLoading();
      }
    }

    async function deleteInvite(inviteId) {
      if (!confirm('Sei sicuro di voler eliminare questo codice?')) return;
      
      showLoading('Eliminazione codice...');
      try {
        const response = await fetch(`${API_BASE}/admin/invites/${inviteId}`, {
          method: 'DELETE'
        });
        
        if (response.ok) {
          showToast('Codice eliminato', 'success');
          loadAdminData();
        } else {
          showToast('Errore nell\'eliminazione', 'error');
        }
      } catch (error) {
        console.error('Error deleting invite:', error);
        showToast('Errore nell\'eliminazione', 'error');
      } finally {
        hideLoading();
      }
    }

    async function createAdminSpot() {
      const username = document.getElementById('spot-username').value.trim();
      const give = document.getElementById('spot-give').value.trim();
      const want = document.getElementById('spot-want').value.trim();
      const region = document.getElementById('spot-region-admin').value;
      const category = document.getElementById('spot-category-admin').value;
      const coordinates = document.getElementById('spot-coordinates-admin').value.trim();
      const description = document.getElementById('spot-description-admin').value.trim();
      
      if (!username || !give || !want || !region) {
        showToast('Compila tutti i campi obbligatori', 'error');
        return;
      }
      
      showLoading('Creazione spot...');
      
      try {
        const response = await fetch(`${API_BASE}/admin/spots`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            give,
            want,
            region,
            coordinates: coordinates || generateRegionCoordinates(region),
            category,
            description: description || 'Spot creato da admin',
            author: username
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          showToast(`âœ… Spot creato per l'utente ${username}`, 'success');
          
          document.getElementById('spot-username').value = '';
          document.getElementById('spot-give').value = '';
          document.getElementById('spot-want').value = '';
          document.getElementById('spot-region-admin').value = '';
          document.getElementById('spot-coordinates-admin').value = '';
          document.getElementById('spot-description-admin').value = '';
          
          loadAdminSpots();
        } else {
          showToast(data.error || 'Errore nella creazione dello spot', 'error');
        }
      } catch (error) {
        console.error('Error creating admin spot:', error);
        showToast('Errore di connessione', 'error');
      } finally {
        hideLoading();
      }
    }

    function generateRegionCoordinates(region) {
      const regionCoordinates = {
        'Abruzzo': { lat: 42.3506, lng: 13.3995 },
        'Basilicata': { lat: 40.6390, lng: 15.8057 },
        'Calabria': { lat: 38.9101, lng: 16.5875 },
        'Campania': { lat: 40.8359, lng: 14.2488 },
        'Emilia-Romagna': { lat: 44.4949, lng: 11.3426 },
        'Friuli-Venezia Giulia': { lat: 45.6371, lng: 13.8038 },
        'Lazio': { lat: 41.8719, lng: 12.5674 },
        'Liguria': { lat: 44.4056, lng: 8.9463 },
        'Lombardia': { lat: 45.4642, lng: 9.1900 },
        'Marche': { lat: 43.6158, lng: 13.5189 },
        'Molise': { lat: 41.5616, lng: 14.6682 },
        'Piemonte': { lat: 45.0703, lng: 7.6869 },
        'Puglia': { lat: 40.9476, lng: 17.1047 },
        'Sardegna': { lat: 39.2238, lng: 9.1217 },
        'Sicilia': { lat: 38.1157, lng: 13.3615 },
        'Toscana': { lat: 43.7696, lng: 11.2558 },
        'Trentino-Alto Adige': { lat: 46.4983, lng: 11.3548 },
        'Umbria': { lat: 42.9380, lng: 12.6144 },
        "Valle d'Aosta": { lat: 45.7376, lng: 7.3207 },
        'Veneto': { lat: 45.4408, lng: 12.3155 }
      };
      
      const baseCoords = regionCoordinates[region] || { lat: 41.8719, lng: 12.5674 };
      const lat = baseCoords.lat + (Math.random() - 0.5) * 0.5;
      const lng = baseCoords.lng + (Math.random() - 0.5) * 0.5;
      return `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
    }

    // ========== FILE UPLOAD FOR SPOTS ==========
    function setupFileUpload() {
      const fileInput = document.getElementById('file-input');
      const uploadArea = document.getElementById('file-upload-area');
      
      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('drag-over');
      });
      
      uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('drag-over');
      });
      
      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('drag-over');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleFileUpload(files[0]);
        }
      });
      
      fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
          handleFileUpload(e.target.files[0]);
        }
      });
    }

    async function handleFileUpload(file) {
      if (!file.name.endsWith('.csv')) {
        showToast('Solo file CSV sono supportati', 'error');
        return;
      }
      
      showLoading('Importazione in corso...');
      
      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          const csv = e.target.result;
          const lines = csv.split('\n');
          const spots = [];
          
          // Skip header
          for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;
            
            const parts = line.split(',');
            if (parts.length < 6) continue;
            
            spots.push({
              author: parts[0].trim(),
              give: parts[1].trim(),
              want: parts[2].trim(),
              region: parts[3].trim(),
              category: parts[4].trim(),
              coordinates: parts[5].trim() || generateRegionCoordinates(parts[3].trim()),
              description: parts[6] ? parts[6].trim() : 'Spot importato da file'
            });
          }
          
          if (spots.length === 0) {
            showToast('Nessuno spot valido trovato nel file', 'error');
            hideLoading();
            return;
          }
          
          // Import spots one by one
          let success = 0;
          let failed = 0;
          
          for (const spot of spots) {
            try {
              const response = await fetch(`${API_BASE}/admin/spots`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(spot)
              });
              
              if (response.ok) {
                success++;
              } else {
                failed++;
              }
            } catch (error) {
              failed++;
            }
          }
          
          const statusDiv = document.getElementById('import-status');
          statusDiv.innerHTML = `
            <div class="alert alert-success">
              âœ… Importati ${success} spot con successo
              ${failed > 0 ? `<br>âŒ ${failed} spot falliti` : ''}
            </div>
          `;
          statusDiv.style.display = 'block';
          
          showToast(`Importati ${success} spot`, 'success');
          loadAdminSpots();
          
        } catch (error) {
          console.error('Error parsing CSV:', error);
          showToast('Errore nel parsing del file CSV', 'error');
        } finally {
          hideLoading();
        }
      };
      
      reader.readAsText(file);
    }

    function downloadTemplate() {
      const csv = 'username,give,want,region,category,coordinates,description\ntest,Ex fabbrica,Hotel,Lombardia,industriale,45.4642|9.1900,Spot di esempio';
      
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'template_spot.csv';
      a.click();
      URL.revokeObjectURL(url);
      
      showToast('Template scaricato!', 'success');
    }

    // ========== USER MANAGEMENT ==========
    async function editUser(userId) {
      const user = state.adminUsers.find(u => u._id === userId);
      if (!user) return;
      
      const content = `
        <div class="form-group">
          <label class="form-label">Username</label>
          <input type="text" class="form-input" id="edit-username" value="${escapeHtml(user.username)}">
        </div>
        
        <div class="form-group">
          <label class="form-label">Bio</label>
          <textarea class="form-textarea" id="edit-bio" rows="3">${escapeHtml(user.bio || '')}</textarea>
        </div>
        
        <div class="form-group">
          <label class="form-label">Ruolo</label>
          <select class="form-select" id="edit-role">
            <option value="user" ${user.role === 'user' ? 'selected' : ''}>User</option>
            <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
          </select>
        </div>
        <div class="form-group">
          <label class="checkbox-label">
            <input type="checkbox" id="edit-content-creator" ${user.isContentCreator ? 'checked' : ''}>
            <span>
              <strong>Content Creator</strong> â€” Badge e stile speciale
            </span>
          </label>
        </div>
        <div class="form-group">
          <label class="form-label">Nuova Password (opzionale)</label>
          <input type="password" class="form-input" id="edit-password" placeholder="Lascia vuoto per non cambiare">
        </div>
        
        <div class="flex gap-2 mt-2">
          <button class="btn btn-ghost" onclick="closeModal('modal-edit-user')">Annulla</button>
          <button class="btn btn-primary btn-lg" onclick="saveUserEdit('${userId}')">Salva Modifiche</button>
        </div>
      `;
      
      document.getElementById('edit-user-content').innerHTML = content;
      openModal('modal-edit-user');
    }

    async function saveUserEdit(userId) {
      const username = document.getElementById('edit-username').value.trim();
      const bio = document.getElementById('edit-bio').value.trim();
      const role = document.getElementById('edit-role').value;
      const password = document.getElementById('edit-password').value;
      const body = { 
        username, 
        bio, 
        role,
        isContentCreator: document.getElementById('edit-content-creator').checked // â† AGGIUNGI
      };
      if (!username) {
        showToast('Username richiesto', 'error');
        return;
      }
      
      showLoading('Salvataggio modifiche...');
      
      try {
        const body = { username, bio, role };
        if (password) {
          body.password = password;
        }
        
        const response = await fetch(`${API_BASE}/admin/users/${userId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        
        if (response.ok) {
          showToast('Utente modificato con successo', 'success');
          closeModal('modal-edit-user');
          loadAdminUsers();
        } else {
          const data = await response.json();
          showToast(data.error || 'Errore nella modifica', 'error');
        }
      } catch (error) {
        console.error('Error editing user:', error);
        showToast('Errore di connessione', 'error');
      } finally {
        hideLoading();
      }
    }

    async function deleteUser(userId) {
      if (!confirm('Sei sicuro di voler eliminare questo utente? Verranno eliminati anche tutti i suoi spot e le sue richieste.')) return;
      
      showLoading('Eliminazione utente...');
      try {
        const response = await fetch(`${API_BASE}/admin/users/${userId}`, {
          method: 'DELETE'
        });
        
        if (response.ok) {
          showToast('Utente eliminato con successo', 'success');
          loadAdminUsers();
        } else {
          const data = await response.json();
          showToast(data.error || 'Errore nell\'eliminazione', 'error');
        }
      } catch (error) {
        console.error('Error deleting user:', error);
        showToast('Errore nell\'eliminazione', 'error');
      } finally {
        hideLoading();
      }
    }

    async function loginAsUser(username) {
  if (!confirm(`Accedere come ${username}? Potrai tornare all'account admin in qualsiasi momento.`)) return;
  
  showLoading('Accesso in corso...');
  try {
    const response = await fetch(`${API_BASE}/admin/login-as`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username })
    });
    
    if (response.ok) {
      const data = await response.json();
      state.user = data.user;
      state.isAdmin = data.isAdmin;
      
      // Chiudi il pannello admin e mostra l'app principale
      document.getElementById('admin-panel').style.display = 'none';
      document.querySelector('header').style.display = 'block';
      document.querySelector('.container').style.display = 'block';
      
      // Setup dell'app principale
      setupEventListeners();
      await loadInitialData();
      showView('market');
      updateUI();
      startVerificationChecker();
      
      showToast(`Accesso effettuato come ${username}`, 'success');
    } else {
      showToast('Errore nell\'accesso', 'error');
    }
  } catch (error) {
    console.error('Error logging in as user:', error);
    showToast('Errore di connessione', 'error');
  } finally {
    hideLoading();
  }
}
    async function editAdminSpot(spotId) {
  const spot = state.adminSpots.find(s => s._id === spotId);
  if (!spot) return;
  
  const content = `
    <div style="margin-bottom: 20px;">
      <h4 style="margin-bottom: 10px;">Modifica Spot: ${escapeHtml(spot.give)}</h4>
      <div class="tags mb-2">
        <span class="badge badge-info">${spot.category}</span>
        <span class="badge ${spot.status === 'active' ? 'badge-success' : spot.status === 'in_trade' ? 'badge-warning' : spot.status === 'completed' ? 'badge-info' : 'badge-danger'}">
          ${spot.status === 'active' ? 'Attivo' : spot.status === 'in_trade' ? 'In scambio' : spot.status === 'completed' ? 'Completato' : 'Eliminato'}
        </span>
      </div>
    </div>
    
    <div class="form-group">
      <label class="form-label">Cosa offri</label>
      <input type="text" class="form-input" id="edit-give" value="${escapeHtml(spot.give)}">
    </div>
    
    <div class="form-group">
      <label class="form-label">Cosa cerchi</label>
      <input type="text" class="form-input" id="edit-want" value="${escapeHtml(spot.want)}">
    </div>
    
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Regione</label>
        <select class="form-select" id="edit-region">
          <option value="">Seleziona regione...</option>
          <option value="Abruzzo" ${spot.region === 'Abruzzo' ? 'selected' : ''}>Abruzzo</option>
          <option value="Basilicata" ${spot.region === 'Basilicata' ? 'selected' : ''}>Basilicata</option>
          <option value="Calabria" ${spot.region === 'Calabria' ? 'selected' : ''}>Calabria</option>
          <option value="Campania" ${spot.region === 'Campania' ? 'selected' : ''}>Campania</option>
          <option value="Emilia-Romagna" ${spot.region === 'Emilia-Romagna' ? 'selected' : ''}>Emilia-Romagna</option>
          <option value="Friuli-Venezia Giulia" ${spot.region === 'Friuli-Venezia Giulia' ? 'selected' : ''}>Friuli-Venezia Giulia</option>
          <option value="Lazio" ${spot.region === 'Lazio' ? 'selected' : ''}>Lazio</option>
          <option value="Liguria" ${spot.region === 'Liguria' ? 'selected' : ''}>Liguria</option>
          <option value="Lombardia" ${spot.region === 'Lombardia' ? 'selected' : ''}>Lombardia</option>
          <option value="Marche" ${spot.region === 'Marche' ? 'selected' : ''}>Marche</option>
          <option value="Molise" ${spot.region === 'Molise' ? 'selected' : ''}>Molise</option>
          <option value="Piemonte" ${spot.region === 'Piemonte' ? 'selected' : ''}>Piemonte</option>
          <option value="Puglia" ${spot.region === 'Puglia' ? 'selected' : ''}>Puglia</option>
          <option value="Sardegna" ${spot.region === 'Sardegna' ? 'selected' : ''}>Sardegna</option>
          <option value="Sicilia" ${spot.region === 'Sicilia' ? 'selected' : ''}>Sicilia</option>
          <option value="Toscana" ${spot.region === 'Toscana' ? 'selected' : ''}>Toscana</option>
          <option value="Trentino-Alto Adige" ${spot.region === 'Trentino-Alto Adige' ? 'selected' : ''}>Trentino-Alto Adige</option>
          <option value="Umbria" ${spot.region === 'Umbria' ? 'selected' : ''}>Umbria</option>
          <option value="Valle d'Aosta" ${spot.region === 'Valle d\'Aosta' ? 'selected' : ''}>Valle d'Aosta</option>
          <option value="Veneto" ${spot.region === 'Veneto' ? 'selected' : ''}>Veneto</option>
        </select>
      </div>
      
      <div class="form-group">
        <label class="form-label">Categoria</label>
        <select class="form-select" id="edit-category">
          <option value="industriale" ${spot.category === 'industriale' ? 'selected' : ''}>Industriale</option>
          <option value="hotel" ${spot.category === 'hotel' ? 'selected' : ''}>Hotel</option>
          <option value="villa" ${spot.category === 'villa' ? 'selected' : ''}>Villa</option>
          <option value="sanitario" ${spot.category === 'sanitario' ? 'selected' : ''}>Sanitario</option>
          <option value="militare" ${spot.category === 'militare' ? 'selected' : ''}>Militare</option>
          <option value="altro" ${spot.category === 'altro' ? 'selected' : ''}>Altro</option>
        </select>
      </div>
    </div>
    
    <div class="form-group">
      <label class="form-label">Coordinate GPS</label>
      <input type="text" class="form-input" id="edit-coordinates" value="${escapeHtml(spot.coordinates || '')}">
    </div>
    
    <div class="form-group">
      <label class="form-label">Descrizione</label>
      <textarea class="form-textarea" id="edit-description" rows="3">${escapeHtml(spot.description || '')}</textarea>
    </div>
    
    <div class="form-group">
      <label class="form-label">Stato</label>
      <select class="form-select" id="edit-status">
        <option value="active" ${spot.status === 'active' ? 'selected' : ''}>Attivo</option>
        <option value="in_trade" ${spot.status === 'in_trade' ? 'selected' : ''}>In Scambio</option>
        <option value="completed" ${spot.status === 'completed' ? 'selected' : ''}>Completato</option>
        <option value="deleted" ${spot.status === 'deleted' ? 'selected' : ''}>Eliminato</option>
      </select>
    </div>
    
    <div class="form-group">
      <label class="form-label">Autore</label>
      <input type="text" class="form-input" id="edit-author" value="${escapeHtml(spot.author)}">
    </div>
    
    <div class="flex gap-2 mt-2">
      <button class="btn btn-ghost" onclick="closeModal('modal-edit-spot')">Annulla</button>
      <button class="btn btn-primary btn-lg" onclick="saveSpotChanges('${spot._id}')">Salva Modifiche</button>
    </div>
  `;
  
  document.getElementById('edit-spot-content').innerHTML = content;
  openModal('modal-edit-spot');
}

async function saveSpotChanges(spotId) {
  const give = document.getElementById('edit-give').value.trim();
  const want = document.getElementById('edit-want').value.trim();
  const region = document.getElementById('edit-region').value;
  const coordinates = document.getElementById('edit-coordinates').value.trim();
  const category = document.getElementById('edit-category').value;
  const description = document.getElementById('edit-description').value.trim();
  const status = document.getElementById('edit-status').value;
  const author = document.getElementById('edit-author').value.trim();
  
  if (!give || !want || !region || !category || !author) {
    showToast('Compila tutti i campi obbligatori', 'error');
    return;
  }
  
  showLoading('Salvataggio modifiche...');
  
  try {
    const response = await fetch(`/api/admin/spots/${spotId}/update`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        give,
        want,
        region,
        coordinates,
        category,
        description,
        status,
        author
      })
    });
    
    const data = await response.json();
    preventHorizontalScroll();
    if (data.success) {
      showToast('Spot modificato con successo!', 'success');
      closeModal('modal-edit-spot');
      
      // Ricarica la lista degli spot
      await loadAdminSpots();
      
      // Aggiorna anche i dati globali
      loadAdminData();
    } else {
      showToast(data.error || 'Errore nel salvataggio', 'error');
    }
  } catch (error) {
    console.error('Error saving spot changes:', error);
    showToast('Errore di connessione', 'error');
  } finally {
    hideLoading();
  }
}
    // ========== DATA LOADING ==========
    async function loadInitialData() {
      showLoading('Caricamento dati...');
      try {
        const [spotsResponse, requestsResponse] = await Promise.all([
          fetch(`${API_BASE}/spots?excludeRequested=true`),
          fetch(`${API_BASE}/trade-requests`)
        ]);
        
        if (!spotsResponse.ok || !requestsResponse.ok) {
          throw new Error('Failed to load data');
        }
        
        state.spots = await spotsResponse.json();
        state.tradeRequests = await requestsResponse.json();
        
      } catch (error) {
        console.error('Error loading initial data:', error);
        showToast('Errore nel caricamento dei dati', 'error');
      } finally {
        hideLoading();
      }
    }

    async function loadMarketSpots() {
      try {
        const response = await fetch(`${API_BASE}/spots?excludeRequested=true`);
        if (response.ok) {
          state.spots = await response.json();
          renderMarket();
        }
      } catch (error) {
        console.error('Error loading market spots:', error);
      } finally {
        hideLoading();
      }
    }

    async function loadUserSpots() {
      try {
        const response = await fetch(`${API_BASE}/spots?userOnly=true`);
        if (response.ok) {
          state.spots = await response.json();
          renderMySpots();
        }
      } catch (error) {
        console.error('Error loading user spots:', error);
      } finally {
        hideLoading();
      }
    }

    async function loadTradeRequests() {
      // Mostra il loading solo se non ci sono giÃ  dati
      if (state.tradeRequests.length === 0) {
        showLoading('Caricamento richieste...');
      }
      
      try {
        const response = await fetch(`${API_BASE}/trade-requests`);
        if (response.ok) {
          const newRequests = await response.json();
          
          // Aggiorna solo se ci sono cambiamenti
          const hasChanges = JSON.stringify(state.tradeRequests) !== JSON.stringify(newRequests);
          
          if (hasChanges) {
            state.tradeRequests = newRequests;
            renderRequests();
            updateUI();
          }
        }
      } catch (error) {
        console.error('Error loading trade requests:', error);
        // Non mostrare errore se Ã¨ solo un problema temporaneo
      } finally {
        hideLoading();
      }
    }
    // ========== NAVIGATION ==========
    function showView(view) {
      // Anti-spam protection
      const now = Date.now();
      if (isChangingView || (now - lastClickTime < CLICK_DELAY)) {
        return;
      }
      
      lastClickTime = now;
      isChangingView = true;
      
      // Remove active class from all nav buttons
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Add active class to clicked button
      document.querySelectorAll('.nav-btn').forEach(btn => {
        if (btn.dataset.route === view) {
          btn.classList.add('active');
        }
      });
      
      // Hide all views
      document.querySelectorAll('section[id^="view-"]').forEach(v => {
        v.classList.add('hidden');
      });
      
      // Show selected view
      document.getElementById(`view-${view}`).classList.remove('hidden');
      
      // Execute view-specific functions
      if (view === 'market') {
        setTimeout(() => {
          renderMarket();
          isChangingView = false;
        }, 50);
      } else if (view === 'requests') {
        setTimeout(() => {
          renderRequests();
          isChangingView = false;
        }, 50);
      } else if (view === 'my-spots') {
        setTimeout(() => {
          renderMySpots();
          isChangingView = false;
        }, 50);
      } else {
        setTimeout(() => {
          isChangingView = false;
        }, 50);
      }
      
      // Smooth scroll to top
      window.scrollTo({ top: 0, behavior: 'smooth' });
      
      if (view === 'my-spots') {
        setTimeout(() => {
          const mapTab = document.querySelector('[data-tab="map"]');
          if (mapTab && mapTab.classList.contains('active')) {
            initMap();
          }
        }, 100);
      }
    }

    // ========== EVENT LISTENERS ==========
    function setupEventListeners() {
      document.querySelectorAll('.nav-btn').forEach(btn => {
        if (btn.dataset.route) {
          btn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            showView(btn.dataset.route);
          });
        }
      });

      ['filter-search', 'filter-category', 'filter-region'].forEach(id => {
        document.getElementById(id).addEventListener('input', renderMarket);
      });
      
      document.getElementById('btn-reset-filters').addEventListener('click', resetFilters);
      document.getElementById('btn-publish').addEventListener('click', publishSpot);
      document.getElementById('btn-send-offer').addEventListener('click', sendOffer);
      document.getElementById('btn-accept-trade').addEventListener('click', acceptTrade);

      // Fix per i tab delle richieste
      document.querySelectorAll('#view-requests .tab').forEach(tab => {
        tab.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          
          const tabName = tab.dataset.tab;
          document.querySelectorAll('#view-requests .tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          
          // Reset all
          document.getElementById('tab-received').classList.add('hidden');
          document.getElementById('tab-sent').classList.add('hidden');
          document.getElementById('tab-history').classList.add('hidden');
          
          // Show selected
          document.getElementById(`tab-${tabName}`).classList.remove('hidden');
        });
      });
      
      // Fix per i tab dell'area privata
      document.querySelectorAll('#view-my-spots .tab').forEach(tab => {
        tab.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          
          const tabName = tab.dataset.tab;
          document.querySelectorAll('#view-my-spots .tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          
          // Reset all
          document.getElementById('tab-published').classList.add('hidden');
          document.getElementById('tab-acquired').classList.add('hidden');
          document.getElementById('tab-profile').classList.add('hidden');
          document.getElementById('tab-map').classList.add('hidden');
          
          // Show selected
          document.getElementById(`tab-${tabName}`).classList.remove('hidden');
          
          if (tabName === 'map') {
            setTimeout(() => {
              initMap();
            }, 100);
          } else if (tabName === 'profile') {
            loadProfileSettings();
          }
        });
      });
      
      window.addEventListener('resize', function() {
        if (map) {
          setTimeout(() => {
            map.invalidateSize();
          }, 200);
        }
      });
    }

    // ========== MAP FUNCTIONS ==========
    function initMap() {
      if (map) {
        try {
          map.remove();
          markers.forEach(marker => marker.remove());
          markers = [];
        } catch (e) {
          console.log('Error removing map:', e);
        }
      }

      const mapContainer = document.getElementById('map');
      if (!mapContainer) return;
      
      mapContainer.style.width = '100%';
      mapContainer.style.height = '100%';

      map = L.map('map', {
        tap: true,
        dragging: true,
        scrollWheelZoom: true,
        touchZoom: true
      }).setView([41.8719, 12.5674], 6);

      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OpenStreetMap & CARTO',
        subdomains: 'abcd',
        maxZoom: 19,
        detectRetina: true
      }).addTo(map);

      addMarkersToMap();
      
      setTimeout(() => {
        if (map) {
          map.invalidateSize(true);
          const italyBounds = L.latLngBounds(
            L.latLng(36.65, 6.63),
            L.latLng(47.09, 18.48)
          );
          map.setMaxBounds(italyBounds);
          map.on('drag', function() {
            map.panInsideBounds(italyBounds, { animate: false });
          });
        }
      }, 300);
    }

    function addMarkersToMap() {
      if (!map) return;
      
      let userSpots = state.spots.filter(s => 
        (s.author === state.user.username && !s.acquired && !s.offeredForTrade && !s.originalSpotId) || 
        (s.acquired && s.currentOwner === state.user.username)
      );

      if (currentMapFilter === 'published') {
        userSpots = userSpots.filter(s => !s.acquired);
      } else if (currentMapFilter === 'acquired') {
        userSpots = userSpots.filter(s => s.acquired);
      }

      markers.forEach(marker => marker.remove());
      markers = [];

      if (userSpots.length === 0) {
        const bounds = L.latLngBounds([[47.09, 6.63], [36.65, 18.48]]);
        map.fitBounds(bounds);
        return;
      }

      userSpots.forEach(spot => {
        let lat, lng;
        
        if (spot.coordinates && spot.coordinates.includes(',')) {
          const cleanedCoords = cleanCoordinates(spot.coordinates);
          const coords = cleanedCoords.split(',').map(c => parseFloat(c.trim()));
          if (coords.length === 2 && !isNaN(coords[0]) && !isNaN(coords[1])) {
            lat = coords[0];
            lng = coords[1];
          }
        }
        
        if (!lat || !lng) {
          lat = 41.8719 + (Math.random() - 0.5) * 5;
          lng = 12.5674 + (Math.random() - 0.5) * 5;
        }
        
        const markerColor = spot.acquired ? '#22c55e' : '#dc2626';
        const markerHtml = `
          <div style="
            background-color: ${markerColor}; 
            width: 24px; 
            height: 24px; 
            border-radius: 50%; 
            border: 3px solid white; 
            box-shadow: 0 2px 6px rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
          ">
            ${spot.acquired ? 'âœ“' : 'â—'}
          </div>
        `;
        
        const markerIcon = L.divIcon({
          className: 'custom-marker',
          html: markerHtml,
          iconSize: [30, 30],
          iconAnchor: [15, 15],
          popupAnchor: [0, -15]
        });
        
        const marker = L.marker([lat, lng], { 
          icon: markerIcon,
          title: spot.give
        })
          .addTo(map)
          .bindPopup(`
            <div style="color: var(--text); max-width: 250px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
              <strong style="font-size: 14px; display: block; margin-bottom: 5px;">${escapeHtml(spot.give)}</strong>
              <div style="font-size: 12px; color: #999; margin-bottom: 8px;">
                ðŸ“ ${escapeHtml(spot.region)}
              </div>
              <div style="font-size: 11px; margin-bottom: 10px; padding: 5px; background: #1a1a1a; border-radius: 4px;">
                ${spot.acquired ? 'âœ… Ottenuto' : 'ðŸ“ Pubblicato'}
                ${spot.offeredForTrade ? ' â€¢ ðŸ”„ In offerta' : ''}
              </div>
              <button onclick="viewSpotDetail('${spot._id || spot.id}'); if(window.map && window.map._popup) window.map._popup.close();" 
                style="background: #dc2626; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 12px; width: 100%;">
                Vedi dettagli
              </button>
            </div>
          `);
        
        markers.push(marker);
      });

      if (markers.length > 0) {
        const group = new L.featureGroup(markers);
        map.fitBounds(group.getBounds().pad(0.1));
        
        if (window.innerWidth <= 768 && markers.length > 1) {
          setTimeout(() => {
            if (map.getZoom() > 8) {
              map.setZoom(8);
            }
          }, 100);
        }
      } else {
        const bounds = L.latLngBounds([[47.09, 6.63], [36.65, 18.48]]);
        map.fitBounds(bounds);
      }
      
      if (window.innerWidth <= 768) {
        setTimeout(() => {
          if (map) {
            map.invalidateSize(true);
          }
        }, 500);
      }
    }

    function refreshMap() {
      if (map) {
        addMarkersToMap();
        showToast('Mappa aggiornata', 'success');
      }
    }

    function zoomToItaly() {
      if (map) {
        const bounds = L.latLngBounds([[47.09, 6.63], [36.65, 18.48]]);
        map.fitBounds(bounds);
        showToast('Zoom sulla posizione Italia', 'info');
      }
    }

    function toggleMarkers(filter) {
      currentMapFilter = filter;
      addMarkersToMap();
      showToast(`Mostrando: ${filter === 'all' ? 'Tutti gli spot' : filter === 'published' ? 'Spot pubblicati' : 'Spot ottenuti'}`, 'info');
    }

    // ========== MARKET ==========
    async function renderMarket() {
      const search = document.getElementById('filter-search').value.toLowerCase();
      const category = document.getElementById('filter-category').value;
      const region = document.getElementById('filter-region').value;

      try {
        const response = await fetch(`${API_BASE}/spots?excludeRequested=true`);
        if (!response.ok) throw new Error('Failed to load spots');
        
        let spots = await response.json();
        
        let filtered = spots.filter(spot => {
          if (spot.status !== 'active') return false;
          if (spot.author === state.user.username) return false;
          if (spot.offeredForTrade) return false;

          const matchSearch = !search || 
            spot.give.toLowerCase().includes(search) ||
            spot.want.toLowerCase().includes(search) ||
            spot.region.toLowerCase().includes(search) ||
            (spot.description && spot.description.toLowerCase().includes(search));
            
          const matchCategory = category === 'all' || spot.category === category;
          const matchRegion = region === 'all' || spot.region === region;

          return matchSearch && matchCategory && matchRegion;
        });

        const grid = document.getElementById('market-grid');
        const count = document.getElementById('results-count');
        
        count.textContent = `${filtered.length} risultat${filtered.length === 1 ? 'o' : 'i'}`;

        if (filtered.length === 0) {
          grid.innerHTML = `
            <div class="card empty-state" style="grid-column:1/-1">
              <div class="empty-state-icon">ðŸ”</div>
              <div>Nessuno spot trovato</div>
              <p class="text-muted">Prova a modificare i filtri</p>
            </div>
          `;
          return;
        }

      grid.innerHTML = filtered.map(spot => {
        const userLevel = getUserLevel(spot.authorSpotCount || 0);
        
        return `
        <div class="spot-card ${spot.authorIsContentCreator ? 'creator-spot-card' : ''}" onclick="viewSpotDetail('${spot._id}')">
          <div class="spot-header">
            <div style="flex:1">
              <div class="spot-title">${escapeHtml(spot.give)}</div>
              <div class="spot-meta">ðŸ“ ${escapeHtml(spot.region)}</div>
            </div>
            <span class="badge badge-success">Disponibile</span>
          </div>
      
          <div class="spot-exchange">
            <div class="spot-exchange-row">
              <strong>Offre:</strong> ${escapeHtml(spot.give)}
            </div>
            <div class="spot-exchange-row">
              <strong>Cerca:</strong> ${escapeHtml(spot.want)}
            </div>
          </div>
      
          <div class="tags">
            <span class="badge badge-info">${spot.category}</span>
            <span class="badge badge-primary">${getTimeAgo(spot.createdAt)}</span>
            ${spot.authorSpotCount >= 1 ? `<span class="badge ${userLevel.color}">${userLevel.name}</span>` : ''}
          </div>
      
          <div class="text-muted ${spot.authorIsContentCreator ? 'creator-name' : 'user-' + userLevel.color}" style="margin-top:10px;font-size:12px;font-weight:500">
            di ${escapeHtml(spot.author)}${spot.authorIsContentCreator ? '<span class="creator-badge">â­ CREATOR</span>' : ''}
          </div>
        </div>
      `;
      }).join('');
      } catch (error) {
        console.error('Error rendering market:', error);
        showToast('Errore nel caricamento del mercato', 'error');
      }
    }

    function resetFilters() {
      document.getElementById('filter-search').value = '';
      document.getElementById('filter-category').value = 'all';
      document.getElementById('filter-region').value = 'all';
      renderMarket();
      showToast('Filtri resettati');
    }

    // ========== MY SPOTS ==========
    async function renderMySpots() {
      await loadUserSpots();
      updateProfileStats();
      
      // Filter to show only original published spots (not acquired, not copies)
      const published = state.spots.filter(s =>
        s.author === state.user.username &&
        !s.acquired &&
        !s.offeredForTrade &&
        !s.originalSpotId
      );

      const acquired = state.spots.filter(s => s.acquired && s.currentOwner === state.user.username);
      
      document.getElementById('published-count').textContent = `(${published.length})`;
      document.getElementById('acquired-count').textContent = `(${acquired.length})`;
      
      renderPublishedSpots();
      renderAcquiredSpots();
    }

    function renderPublishedSpots() {
      // Show only original published spots
      const mySpots = state.spots.filter(s => 
        s.author === state.user.username && 
        !s.acquired && 
        !s.offeredForTrade &&
        !s.originalSpotId
      );
      
      const grid = document.getElementById('published-spots-grid');

      if (mySpots.length === 0) {
        grid.innerHTML = `
          <div class="card empty-state" style="grid-column:1/-1">
            <div class="empty-state-icon">ðŸ“</div>
            <div>Nessuno spot pubblicato</div>
            <p class="text-muted">Pubblica il tuo primo spot per iniziare</p>
            <button class="btn btn-primary mt-2" onclick="showView('new')">+ Pubblica spot</button>
          </div>
        `;
        return;
      }

      grid.innerHTML = mySpots.map(spot => `
        <div class="spot-card">
          <div class="spot-header">
            <div style="flex:1">
              <div class="spot-title">${escapeHtml(spot.give)}</div>
              <div class="spot-meta">ðŸ“ ${escapeHtml(spot.region)}</div>
            </div>
            <span class="badge badge-${spot.status === 'active' ? 'success' : spot.status === 'in_trade' ? 'warning' : spot.status === 'completed' ? 'info' : 'danger'}">
              ${spot.status === 'active' ? 'Attivo' : spot.status === 'in_trade' ? 'In scambio' : spot.status === 'completed' ? 'Completato' : 'Eliminato'}
            </span>
          </div>

          <div class="spot-exchange">
            <div class="spot-exchange-row">
              <strong>Offri:</strong> ${escapeHtml(spot.give)}
            </div>
            <div class="spot-exchange-row">
              <strong>Cerchi:</strong> ${escapeHtml(spot.want)}
            </div>
          </div>

          <div class="tags">
            <span class="badge badge-info">${spot.category}</span>
            <span class="badge badge-primary">${getTimeAgo(spot.createdAt)}</span>
          </div>
          
          <div class="spot-actions">
            <button class="btn btn-ghost" onclick="viewSpotDetail('${spot._id}')">Dettagli</button>
            ${spot.coordinates && spot.coordinates.includes(',') ? `
              <button class="btn btn-primary" onclick="openInGoogleMaps('${escapeHtml(spot.coordinates)}', '${escapeHtml(spot.give)}')">
                <span style="display:flex;align-items:center;gap:4px">ðŸ—ºï¸ Mappa</span>
              </button>
            ` : ''}
            ${spot.status === 'active' ? `<button class="btn btn-danger" onclick="deleteSpot('${spot._id}')">Elimina</button>` : ''}
          </div>
        </div>
      `).join('');
    }

    function renderAcquiredSpots() {
      const acquiredSpots = state.spots.filter(s => s.acquired && s.currentOwner === state.user.username);
      
      const grid = document.getElementById('acquired-spots-grid');

      if (acquiredSpots.length === 0) {
        grid.innerHTML = `
          <div class="card empty-state" style="grid-column:1/-1">
            <div class="empty-state-icon">ðŸ†</div>
            <div>Nessuno spot ottenuto</div>
            <p class="text-muted">Completa alcuni scambi per ottenere nuovi spot</p>
            <button class="btn btn-primary mt-2" onclick="showView('market')">Vai al mercato</button>
          </div>
        `;
        return;
      }

      grid.innerHTML = acquiredSpots.map(spot => `
        <div class="spot-card">
          <div class="spot-header">
            <div style="flex:1">
              <div class="spot-title">${escapeHtml(spot.give)}</div>
              <div class="spot-meta">ðŸ“ ${escapeHtml(spot.region)}</div>
            </div>
            <span class="badge badge-success">Ottenuto</span>
            ${spot.offeredForTrade ? '<span class="badge badge-warning" style="margin-left:4px">Offerto</span>' : ''}
          </div>

          <div class="spot-exchange">
            <div class="spot-exchange-row">
              <strong>Ottenuto da:</strong> ${escapeHtml(spot.originalAuthor || 'Sconosciuto')}
            </div>
            <div class="spot-exchange-row">
              <strong>Ottenuto il:</strong> ${new Date(spot.acquiredDate || Date.now()).toLocaleDateString('it-IT')}
            </div>
          </div>

          <div class="tags">
            <span class="badge badge-info">${spot.category}</span>
            <span class="badge badge-warning">Scambio</span>
          </div>
          
          <div class="spot-actions">
            <button class="btn btn-ghost" onclick="viewSpotDetail('${spot._id}')">Dettagli</button>
            ${spot.coordinates ? `
              <button class="btn btn-primary" onclick="openInGoogleMaps('${escapeHtml(spot.coordinates)}', '${escapeHtml(spot.give)}')">
                <span style="display:flex;align-items:center;gap:4px">ðŸ—ºï¸ Mappa</span>
              </button>
            ` : ''}
            ${!spot.offeredForTrade ? `
              <button class="btn btn-success" onclick="offerAcquiredSpot('${spot._id}')">Offri in scambio</button>
            ` : `
              <button class="btn btn-ghost" onclick="cancelOffer('${spot._id}')">Annulla offerta</button>
            `}
          </div>
        </div>
      `).join('');
    }

    async function loadProfileSettings() {
      document.getElementById('profile-username').value = state.user.username;
    }

    async function saveProfileSettings() {
      showLoading('Salvataggio impostazioni...');
      try {
        const response = await fetch(`${API_BASE}/profile`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            username: document.getElementById('profile-username').value,
            bio: document.getElementById('profile-bio').value,
            settings: {
              privateProfile: document.getElementById('private-profile-toggle').checked
            }
          })
        });
        
        if (response.ok) {
          showToast('Impostazioni salvate!', 'success');
        }
      } catch (error) {
        console.error('Error saving profile:', error);
        showToast('Errore nel salvataggio', 'error');
      } finally {
        hideLoading();
      }
    }

    function updateProfileStats() {
      const publishedSpots = state.spots.filter(s => 
        s.author === state.user.username && 
        !s.acquired && 
        !s.offeredForTrade &&
        !s.originalSpotId
      ).length;
      
      const acquiredSpots = state.spots.filter(s => s.acquired && s.currentOwner === state.user.username).length;
      
      const completedTrades = state.tradeRequests.filter(r => 
        r.status === 'accepted' && 
        (r.fromUser === state.user.username || r.toUser === state.user.username)
      ).length;
      
      const totalTrades = state.tradeRequests.filter(r => 
        r.fromUser === state.user.username || r.toUser === state.user.username
      ).length;
      
      const successRate = totalTrades > 0 ? Math.round((completedTrades / totalTrades) * 100) : 0;
      
      document.getElementById('total-spots').textContent = publishedSpots + acquiredSpots;
      document.getElementById('acquired-spots').textContent = acquiredSpots;
      document.getElementById('completed-trades').textContent = completedTrades;
      document.getElementById('success-rate').textContent = `${successRate}%`;
    }

    // ========== REQUESTS ==========
    async function renderRequests() {
      const received = state.tradeRequests.filter(r => 
        r.toUser === state.user.username && 
        r.adminApproved && 
        !r.adminRejected &&
        r.status === 'pending'
      );
      
      const sent = state.tradeRequests.filter(r => 
        r.fromUser === state.user.username &&
        r.status === 'pending'
      );
      
      const history = state.tradeRequests.filter(r => 
        (r.fromUser === state.user.username || (r.toUser === state.user.username && r.adminApproved && !r.adminRejected)) &&
        (r.status === 'accepted' || r.status === 'rejected')
      );

      document.getElementById('received-count').textContent = `(${received.length})`;
      document.getElementById('sent-count').textContent = `(${sent.length})`;

      const receivedContainer = document.getElementById('received-requests');
      if (received.length === 0) {
        receivedContainer.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ðŸ“­</div>
            <div>Nessuna richiesta ricevuta</div>
            <p class="text-muted">Le richieste approvate dall'admin appariranno qui</p>
          </div>
        `;
      } else {
        receivedContainer.innerHTML = received.map(req => renderTradeRequest(req, 'received')).join('');
      }

      const sentContainer = document.getElementById('sent-requests');
      if (sent.length === 0) {
        sentContainer.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ðŸ“¤</div>
            <div>Nessuna richiesta inviata</div>
            <p class="text-muted">Le richieste attive appariranno qui</p>
          </div>
        `;
      } else {
        sentContainer.innerHTML = sent.map(req => renderTradeRequest(req, 'sent')).join('');
      }
      
      const historyContainer = document.getElementById('history-requests');
      if (history.length === 0) {
        historyContainer.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ðŸ“‹</div>
            <div>Nessuno scambio concluso</div>
          </div>
        `;
      } else {
        historyContainer.innerHTML = history.map(req => renderTradeRequest(req, 'history')).join('');
      }

      updateRequestsCount();
    }

    function renderTradeRequest(req, type) {
      const spot = req.spotId || {};
      const offeredSpots = req.offeredSpots || [];

      let statusBadge = '';
      let actions = '';

      switch(req.status) {
        case 'pending':
          if (req.adminApproved) {
            statusBadge = '<span class="trade-status pending">â³ In attesa di risposta</span>';
            if (type === 'received') {
              actions = `<button class="btn btn-success" onclick="chooseSpotFromOffer('${req._id}')">Scegli spot</button>`;
            }
          } else {
            statusBadge = '<span class="trade-status verifying">ðŸ”„ In attesa di approvazione admin</span>';
          }
          break;
        case 'verifying':
          statusBadge = '<span class="trade-status verifying">â³ In elaborazione...</span>';
          break;
        case 'accepted':
          statusBadge = '<span class="trade-status accepted">âœ… Completato</span>';
          break;
        case 'rejected':
          statusBadge = '<span class="trade-status rejected">âŒ Rifiutato</span>';
          break;
      }

      const isReceived = type === 'received';
      const isSent = type === 'sent';
      
      const spotOfferedHtml = offeredSpots.length > 0 ? `
        <div class="expandable-spots">
          <div class="expandable-header" onclick="toggleExpandableSpots(this)">
            <div>
              <strong>Spot ${isReceived ? 'offerti' : isSent ? 'richiesti' : 'scambiati'} (${offeredSpots.length})</strong>
            </div>
            <span style="font-size: 18px;">â–¼</span>
          </div>
          <div class="expandable-content">
            ${offeredSpots.map(s => `
              <div class="offered-spot-detail">
                <strong>${escapeHtml(s.give || 'N/A')}</strong>
                <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">
                  ðŸ“ ${escapeHtml(s.region || '')} â€¢ ${s.category || ''}
                </div>
                <div style="font-size: 11px; margin-top: 6px;">
                  ${escapeHtml((s.description || '').substring(0, 100))}${s.description && s.description.length > 100 ? '...' : ''}
                </div>
                ${req.selectedSpotId && req.selectedSpotId._id === s._id ? '<span class="badge badge-success" style="margin-top:6px">âœ“ Scelto</span>' : ''}
              </div>
            `).join('')}
          </div>
        </div>
      ` : '';
      
      return `
        <div class="trade-request">
          <div class="flex-between mb-2">
            <div>
              <strong>${isReceived ? 'Da' : isSent ? 'A' : 'Con'}: ${escapeHtml(isReceived ? req.fromUser : isSent ? req.toUser : (req.fromUser === state.user.username ? req.toUser : req.fromUser))}</strong>
              <div class="text-muted" style="font-size:12px;margin-top:2px">${getTimeAgo(req.createdAt)}</div>
            </div>
            ${statusBadge}
          </div>

          <div class="mb-2">
            <strong>Spot ${isReceived ? 'richiesto' : isSent ? 'offerto' : ''}:</strong> ${escapeHtml(spot.give || 'N/A')}
          </div>

          ${spotOfferedHtml}

          ${req.status === 'accepted' && req.selectedSpotId ? renderCoordinates(req) : ''}

          ${actions ? `<div style="margin-top: 12px;">${actions}</div>` : ''}
        </div>
      `;
    }

    function toggleExpandableSpots(element) {
      const content = element.nextElementSibling;
      const arrow = element.querySelector('span');
      
      if (content.classList.contains('expanded')) {
        content.classList.remove('expanded');
        arrow.textContent = 'â–¼';
      } else {
        content.classList.add('expanded');
        arrow.textContent = 'â–²';
      }
    }

    function renderCoordinates(req) {
      const spot = req.spotId || {};
      const selectedSpot = req.selectedSpotId || {};
      
      let html = '<div class="coordinates-box">';
      html += '<strong>ðŸŽ‰ Scambio completato! Ecco le coordinate:</strong>';
      
      if (req.fromUser === state.user.username) {
        html += `<div style="margin-top:6px">ðŸ“ ${escapeHtml(spot.give || '')}: ${escapeHtml(spot.coordinates || 'Non disponibili')}</div>`;
        if (spot.coordinates) {
          html += `<button class="btn btn-primary" style="margin-top:8px;padding:6px 12px;font-size:12px" onclick="openInGoogleMaps('${escapeHtml(spot.coordinates)}', '${escapeHtml(spot.give)}')">
            Apri in Google Maps
          </button>
          `;
        }
      } else {
        html += `<div style="margin-top:6px">ðŸ“ ${escapeHtml(selectedSpot.give || '')}: ${escapeHtml(selectedSpot.coordinates || 'Non disponibili')}</div>`;
        if (selectedSpot.coordinates) {
          html += `<button class="btn btn-primary" style="margin-top:8px;padding:6px 12px;font-size:12px" onclick="openInGoogleMaps('${escapeHtml(selectedSpot.coordinates)}', '${escapeHtml(selectedSpot.give)}')">
            Apri in Google Maps
          </button>
          `;
        }
      }
      
      html += '</div>';
      return html;
    }

    // ========== TRADE ACTIONS ==========
    async function openOfferModal(spotId) {
      showLoading('Caricamento spot...');
      try {
        const response = await fetch(`${API_BASE}/spots?userOnly=true`);
        const mySpots = await response.json();
        
        const myActiveSpots = mySpots.filter(s => 
          s.author === state.user.username && 
          s.status === 'active' &&
          !s.acquired &&
          !s.offeredForTrade &&
          !s.originalSpotId
        );

        if (myActiveSpots.length === 0) {
          showToast('Devi avere almeno uno spot attivo per fare una proposta', 'error');
          showView('new');
          return;
        }

        state.currentOfferId = spotId;
        state.selectedOfferSpots = [];

        const list = document.getElementById('offer-spots-list');
        list.innerHTML = myActiveSpots.map(spot => `
          <label class="spot-selector">
            <input type="checkbox" value="${spot._id}" onchange="toggleOfferSpot('${spot._id}')">
            <div class="spot-selector-content">
              <strong>${escapeHtml(spot.give)}</strong>
              <div class="text-muted" style="font-size:12px;margin-top:2px">ðŸ“ ${escapeHtml(spot.region)}</div>
            </div>
          </label>
        `).join('');

        closeModal('modal-detail');
        openModal('modal-offer');
      } catch (error) {
        console.error('Error opening offer modal:', error);
        showToast('Errore nel caricamento degli spot', 'error');
      } finally {
        hideLoading();
      }
    }

    function toggleOfferSpot(spotId) {
      const checkbox = document.querySelector(`input[value="${spotId}"]`);
      const selector = checkbox.closest('.spot-selector');
      
      if (checkbox.checked) {
        if (state.selectedOfferSpots.length >= 3) {
          showToast('Puoi selezionare massimo 3 spot', 'error');
          checkbox.checked = false;
          selector.classList.remove('selected');
          return;
        }
        state.selectedOfferSpots.push(spotId);
        selector.classList.add('selected');
      } else {
        const index = state.selectedOfferSpots.indexOf(spotId);
        if (index > -1) {
          state.selectedOfferSpots.splice(index, 1);
        }
        selector.classList.remove('selected');
      }
    }

    async function sendOffer() {
      if (state.selectedOfferSpots.length === 0) {
        showToast('Seleziona almeno uno spot', 'error');
        return;
      }

      showLoading('Invio proposta...');

      try {
        const response = await fetch(`${API_BASE}/trade-requests`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            spotId: state.currentOfferId,
            offeredSpots: state.selectedOfferSpots
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          closeModal('modal-offer');
          showToast('Proposta inviata! Attendi l\'approvazione dell\'admin.', 'success');
          showView('requests');
          await loadTradeRequests();
          await loadMarketSpots();
          await loadUserSpots();
        } else {
          showToast(data.error || 'Errore nell\'invio della proposta', 'error');
        }
      } catch (error) {
        console.error('Error sending offer:', error);
        showToast('Errore nell\'invio della proposta', 'error');
      } finally {
        hideLoading();
      }
    }

    async function chooseSpotFromOffer(requestId) {
      state.currentRequestId = requestId;
      const request = state.tradeRequests.find(r => r._id === requestId);
      
      if (!request) {
        showToast('Richiesta non trovata', 'error');
        return;
      }

      if (!request.adminApproved) {
        showToast('Questa richiesta non Ã¨ ancora stata approvata dall\'admin', 'error');
        return;
      }

      const offeredSpots = request.offeredSpots || [];

      const list = document.getElementById('choose-spots-list');
      list.innerHTML = offeredSpots.map(spot => `
        <label class="spot-selector">
          <input type="radio" name="chosen-spot" value="${spot._id}" onchange="selectSpotForTrade('${spot._id}')">
          <div class="spot-selector-content">
            <strong>${escapeHtml(spot.give || '')}</strong>
            <div class="text-muted" style="font-size:12px;margin-top:2px">ðŸ“ ${escapeHtml(spot.region || '')}</div>
            <div style="margin-top:6px;font-size:12px">${escapeHtml((spot.description || '').substring(0, 100))}${spot.description && spot.description.length > 100 ? '...' : ''}</div>
            <div class="tags" style="margin-top:6px">
              <span class="badge badge-info">${spot.category || ''}</span>
            </div>
          </div>
        </label>
      `).join('');

      openModal('modal-choose');
    }

    function selectSpotForTrade(spotId) {
      document.querySelectorAll('.spot-selector').forEach(el => {
        el.classList.remove('selected');
      });
      
      const selectedSelector = document.querySelector(`input[value="${spotId}"]`).closest('.spot-selector');
      if (selectedSelector) {
        selectedSelector.classList.add('selected');
      }
    }

    async function acceptTrade() {
      const chosen = document.querySelector('input[name="chosen-spot"]:checked');
      if (!chosen) {
        showToast('Seleziona uno spot', 'error');
        return;
      }

      showLoading('Accettazione scambio...');

      try {
        const response = await fetch(`${API_BASE}/trade-requests/${state.currentRequestId}/accept`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ selectedSpotId: chosen.value })
        });
        
        if (response.ok) {
          closeModal('modal-choose');
          showToast('Scambio completato con successo!', 'success');
          await loadTradeRequests();
          await loadUserSpots();
        } else {
          const data = await response.json();
          showToast(data.error || 'Errore nell\'accettazione', 'error');
        }
      } catch (error) {
        console.error('Error accepting trade:', error);
        showToast('Errore nell\'accettazione', 'error');
      } finally {
        hideLoading();
      }
    }

    async function offerAcquiredSpot(spotId) {
      showLoading('Offerta spot...');
      try {
        const response = await fetch(`${API_BASE}/spots/${spotId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ offeredForTrade: true })
        });
        
        if (response.ok) {
          showToast('Spot ora disponibile per lo scambio!', 'success');
          await loadUserSpots();
        }
      } catch (error) {
        console.error('Error offering spot:', error);
        showToast('Errore nell\'offerta dello spot', 'error');
      } finally {
        hideLoading();
      }
    }

    async function cancelOffer(spotId) {
      showLoading('Annullamento offerta...');
      try {
        const response = await fetch(`${API_BASE}/spots/${spotId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ offeredForTrade: false })
        });
        
        if (response.ok) {
          showToast('Offerta annullata', 'success');
          await loadUserSpots();
        }
      } catch (error) {
        console.error('Error canceling offer:', error);
        showToast('Errore nell\'annullamento', 'error');
      } finally {
        hideLoading();
      }
    }

    // ========== VERIFICATION CHECKER ==========
  function startVerificationChecker() {
      // Non avviare un intervallo fisso
      // Aggiorneremo le richieste solo quando necessario
      console.log('Verification checker ready');
    }
    
    // Nuova funzione per aggiornare le richieste quando necessario
    function updateRequestsIfNeeded() {
      // Aggiorna solo se siamo nella view delle richieste
      const currentView = document.querySelector('section:not(.hidden)').id.replace('view-', '');
      if (currentView === 'requests') {
        loadTradeRequests();
      }
    }
    
    // Aggiorna le richieste quando:
    // 1. L'utente torna online
    window.addEventListener('online', () => {
      showToast('Connessione ripristinata', 'success');
      updateRequestsIfNeeded();
    });
    
    // 2. Quando la pagina diventa visibile
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) {
        updateRequestsIfNeeded();
      }
    });
    
    // 3. Quando l'utente interagisce con l'app
    document.addEventListener('click', () => {
      updateRequestsIfNeeded();
    });
    
    // 4. Quando cambia view
    const originalShowView = showView;
    showView = function(view) {
      originalShowView.call(this, view);
      
      // Aggiorna le richieste se stiamo entrando nella view delle richieste
      if (view === 'requests') {
        setTimeout(() => {
          loadTradeRequests();
        }, 100);
      }
    };
    
    // 5. Aggiorna periodicamente ma meno frequentemente (ogni 60 secondi invece di 10)
    setInterval(() => {
      const currentView = document.querySelector('section:not(.hidden)').id.replace('view-', '');
      if (currentView === 'requests') {
        loadTradeRequests();
      }
    }, 60000); // 60 secondi

    // ========== PUBLISH SPOT ==========
    async function publishSpot() {
      const give = document.getElementById('input-give').value.trim();
      const want = document.getElementById('input-want').value.trim();
      const region = document.getElementById('input-region').value;
      const coordinatesInput = document.getElementById('input-coordinates').value.trim();
      const category = document.getElementById('input-category').value;
      const description = document.getElementById('input-description').value.trim();
      const legal = document.getElementById('input-legal').checked;

      if (!give || !want || !region) {
        showToast('Compila tutti i campi obbligatori', 'error');
        return;
      }

      if (!coordinatesInput) {
        showToast('Inserisci le coordinate GPS o un link Google Maps', 'error');
        return;
      }

      if (!legal) {
        showToast('Devi confermare di avere accordi per questo spot', 'error');
        return;
      }

      showLoading('Pubblicazione spot...');

      let coordinates = await extractCoordinatesFromLink(coordinatesInput);
      
      if (!coordinates || !coordinates.includes(',')) {
        showToast('Coordinate non valide. Inserisci coordinate nel formato "lat, lng" o un link Google Maps valido', 'error');
        hideLoading();
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/spots`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            give, 
            want, 
            region, 
            coordinates,
            category,
            description: description || 'Nessuna descrizione',
            isPrivate: document.getElementById('input-private').checked // â† AGGIUNGI QUESTA RIGA
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          document.getElementById('input-give').value = '';
          document.getElementById('input-want').value = '';
          document.getElementById('input-region').value = '';
          document.getElementById('input-coordinates').value = '';
          document.getElementById('input-description').value = '';
          document.getElementById('input-legal').checked = false;
          document.getElementById('input-private').checked = false; // â† AGGIUNGI QUESTA RIGA
          showToast('Spot pubblicato con successo!', 'success');
          showView('my-spots');
          await loadUserSpots();
        } else {
          showToast(data.error || 'Errore nella pubblicazione', 'error');
        }
      } catch (error) {
        console.error('Error publishing spot:', error);
        showToast('Errore nella pubblicazione', 'error');
      } finally {
        hideLoading();
      }
    }

    async function deleteSpot(spotId) {
      if (!confirm('Sei sicuro di voler eliminare questo spot?')) return;
      
      showLoading('Eliminazione spot...');
      try {
        const response = await fetch(`${API_BASE}/spots/${spotId}`, {
          method: 'DELETE'
        });
        
        if (response.ok) {
          showToast('Spot eliminato', 'success');
          await loadUserSpots();
        } else {
          const data = await response.json();
          showToast(data.error || 'Errore nell\'eliminazione', 'error');
        }
      } catch (error) {
        console.error('Error deleting spot:', error);
        showToast('Errore nell\'eliminazione', 'error');
      } finally {
        hideLoading();
      }
    }

    // ========== SPOT DETAIL ==========
    async function viewSpotDetail(spotId) {
      showLoading('Caricamento dettagli...');
      try {
        const response = await fetch(`${API_BASE}/spots`);
        const spots = await response.json();
        const spot = spots.find(s => s._id === spotId);
        
        if (!spot) {
          showToast('Spot non trovato', 'error');
          return;
        }

        document.getElementById('detail-title').textContent = spot.give;
        
        const content = document.getElementById('detail-content');
        content.innerHTML = `
          <div class="tags mb-2">
            <span class="badge badge-info">${spot.category}</span>
            <span class="badge badge-${spot.status === 'active' ? 'success' : spot.status === 'in_trade' ? 'warning' : spot.status === 'completed' ? 'info' : 'danger'}">
              ${spot.status === 'active' ? 'Attivo' : spot.status === 'in_trade' ? 'In scambio' : spot.status === 'completed' ? 'Completato' : 'Eliminato'}
            </span>
            ${spot.isPrivate ? '<span class="badge badge-warning">ðŸ”’ Privato</span>' : ''}
            ${spot.acquired ? '<span class="badge badge-warning">Ottenuto</span>' : ''}
            ${spot.offeredForTrade ? '<span class="badge badge-primary">In offerta</span>' : ''}
          </div>

          <div class="mb-2">
            <strong>Autore:</strong> ${escapeHtml(spot.author)}
            ${spot.originalAuthor ? `<div style="font-size:12px;color:var(--text-muted);margin-top:2px">Originale: ${escapeHtml(spot.originalAuthor)}</div>` : ''}
          </div>

          <div class="mb-2">
            <strong>Zona:</strong> ðŸ“ ${escapeHtml(spot.region)}
          </div>

          <div class="mb-2">
            <strong>Pubblicato:</strong> ${getTimeAgo(spot.createdAt)}
            ${spot.acquiredDate ? `<div style="font-size:12px;color:var(--text-muted);margin-top:2px">Ottenuto: ${new Date(spot.acquiredDate).toLocaleDateString('it-IT')}</div>` : ''}
          </div>

          <div class="spot-exchange mb-2">
            <div class="spot-exchange-row">
              <strong>${spot.acquired ? 'Spot' : 'Offre'}:</strong> ${escapeHtml(spot.give)}
            </div>
            ${!spot.acquired ? `
              <div class="spot-exchange-row">
                <strong>Cerca:</strong> ${escapeHtml(spot.want)}
              </div>
            ` : ''}
          </div>

          <div class="mb-2">
            <strong>Descrizione:</strong>
            <p style="margin-top:6px;font-size:13px">${escapeHtml(spot.description || 'Nessuna descrizione')}</p>
          </div>

          ${spot.coordinates && (spot.status === 'completed' || spot.acquired) ? `
            <div class="coordinates-box">
              <strong>ðŸ“ Coordinate GPS</strong>
              <div style="margin-top:6px">${escapeHtml(spot.coordinates)}</div>
              <button class="btn btn-primary" style="margin-top:8px;padding:6px 12px;font-size:12px" onclick="openInGoogleMaps('${escapeHtml(spot.coordinates)}', '${escapeHtml(spot.give)}')">
                Apri in Google Maps
              </button>
            </div>
          ` : ''}
        `;

        const actions = document.getElementById('detail-actions');
        if (spot.author !== state.user.username && spot.status === 'active' && !spot.hasPendingTradeRequest) {
          actions.innerHTML = `
            <button class="btn btn-primary btn-lg" onclick="openOfferModal('${spot._id}')">
              Proponi scambio
            </button>
          `;
        } else if (spot.author === state.user.username && spot.status === 'active') {
          actions.innerHTML = `
            <div class="flex gap-2">
              <button class="btn btn-ghost" onclick="closeModal('modal-detail')">Chiudi</button>
              <button class="btn btn-danger" onclick="deleteSpot('${spot._id}')">Elimina spot</button>
            </div>
          `;
        } else if (spot.hasPendingTradeRequest) {
          actions.innerHTML = `
            <div class="alert alert-info">
              â³ Hai giÃ  inviato una richiesta per questo spot
            </div>
          `;
        } else {
          actions.innerHTML = '';
        }

        openModal('modal-detail');
      } catch (error) {
        console.error('Error viewing spot detail:', error);
        showToast('Errore nel caricamento dei dettagli', 'error');
      } finally {
        hideLoading();
      }
    }

    // ========== GOOGLE MAPS ==========
    function openInGoogleMaps(coordinates, title) {
      if (!coordinates) {
        showToast('Coordinate non disponibili', 'error');
        return;
      }
      
      const cleanedCoords = cleanCoordinates(coordinates);
      
      if (!cleanedCoords || !cleanedCoords.includes(',')) {
        showToast('Coordinate non valide', 'error');
        return;
      }
      
      const url = `https://www.google.com/maps?q=${encodeURIComponent(cleanedCoords)}&z=15&t=s&hl=it&layer=s`;
      
      window.open(url, '_blank');
    }

    // ========== MODAL ==========
    function openModal(id) {
      document.getElementById(id).classList.add('show');
    }

    function closeModal(id) {
      document.getElementById(id).classList.remove('show');
    }

    // ========== UI UPDATES ==========
    function updateUI() {
      updateRequestsCount();
      updateUserProfileDisplay();
    }
    function updateUserProfileDisplay() {
      if (state.user) {
        document.getElementById('user-profile-display').style.display = 'flex';
        const initial = state.user.username.charAt(0).toUpperCase();
        document.getElementById('user-avatar').textContent = initial;
        document.getElementById('user-display-name').textContent = state.user.username;
      } else {
        document.getElementById('user-profile-display').style.display = 'none';
      }
    }
    function updateRequestsCount() {
      const pendingReceived = state.tradeRequests.filter(r => 
        r.toUser === state.user.username && 
        r.adminApproved && 
        !r.adminRejected &&
        r.status === 'pending'
      ).length;

      const badge = document.getElementById('requests-count');
      if (pendingReceived > 0) {
        badge.textContent = pendingReceived;
        badge.classList.remove('hidden');
      } else {
        badge.classList.add('hidden');
      }
    }

    // ========== UTILITIES ==========
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function getTimeAgo(timestamp) {
      if (!timestamp) return 'Sconosciuto';
      const date = new Date(timestamp);
      if (isNaN(date.getTime())) return 'Sconosciuto';
      
      const diff = Date.now() - date.getTime();
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(minutes / 60);
      const days = Math.floor(hours / 24);

      if (days > 0) return `${days}g fa`;
      if (hours > 0) return `${hours}h fa`;
      if (minutes > 0) return `${minutes}m fa`;
      return 'Ora';
    }

    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast show ' + type;
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        showToast('Codice copiato negli appunti!', 'success');
      }).catch(err => {
        console.error('Error copying to clipboard:', err);
        showToast('Errore nella copia', 'error');
      });
    }
    
    // Prevenzione zoom su mobile
    document.addEventListener('touchstart', function(event) {
      if (event.touches.length > 1) {
        event.preventDefault();
      }
    }, { passive: false });
    
    document.addEventListener('gesturestart', function(event) {
      event.preventDefault();
    });
    
    document.addEventListener('gesturechange', function(event) {
      event.preventDefault();
    });
    
    document.addEventListener('gestureend', function(event) {
      event.preventDefault();
    });
    
    // Prevenzione double-tap zoom
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function(event) {
      const now = Date.now();
      if (now - lastTouchEnd <= 300) {
        event.preventDefault();
      }
      lastTouchEnd = now;
    }, { passive: false });

// Prevenzione scroll orizzontale su mobile
function preventHorizontalScroll() {
  document.addEventListener('touchmove', function(e) {
    if (e.touches.length > 1) {
      e.preventDefault();
      return;
    }
    
    const touch = e.touches[0];
    const x = touch.clientX;
    const y = touch.clientY;
    
    // Se il movimento Ã¨ principalmente orizzontale, previenilo
    if (Math.abs(e.movementX) > Math.abs(e.movementY)) {
      e.preventDefault();
    }
  }, { passive: false });
  
  // Previeni lo scroll orizzontale con la rotellina del mouse
  document.addEventListener('wheel', function(e) {
    if (Math.abs(e.deltaX) > Math.abs(e.deltaY)) {
      e.preventDefault();
    }
  }, { passive: false });
  
  // Fix per iOS
  document.addEventListener('touchstart', function(e) {
    if (e.touches.length === 1) {
      const touch = e.touches[0];
      this.startX = touch.pageX;
      this.startY = touch.pageY;
    }
  }, { passive: true });
  
  document.addEventListener('touchmove', function(e) {
    if (e.touches.length === 1) {
        const touch = e.touches[0];
        const diffX = touch.pageX - this.startX;
        const diffY = touch.pageY - this.startY;
        
        // Se il movimento Ã¨ piÃ¹ orizzontale che verticale, previenilo
        if (Math.abs(diffX) > Math.abs(diffY)) {
          e.preventDefault();
        }
      }
    }, { passive: false });
  }
  // ========== USER LEVEL SYSTEM ==========
function getUserLevel(spotCount) {
  if (spotCount >= 100) return { level: 7, name: 'Leggenda', color: 'level-7' };
  if (spotCount >= 50) return { level: 6, name: 'Maestro', color: 'level-6' };
  if (spotCount >= 30) return { level: 5, name: 'Esperto', color: 'level-5' };
  if (spotCount >= 15) return { level: 4, name: 'Veterano', color: 'level-4' };
  if (spotCount >= 10) return { level: 3, name: 'Avanzato', color: 'level-3' };
  if (spotCount >= 5) return { level: 2, name: 'Intermedio', color: 'level-2' };
  return { level: 1, name: 'Novizio', color: 'level-1' };
}
  // Chiama la funzione all'inizio

    
    // ========== START APP ==========
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
